<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Debrid Media Manager Hash List</title>
		<script src="api-manager.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
				overflow: hidden;
				font-family: sans-serif;
			}
			#panel {
				height: 80px;
				background-color: #f2f2f2;
				display: flex;
				align-items: center;
				padding: 0 10px;
				flex-wrap: wrap;
			}

			#panel #currentPath {
				flex-grow: 1;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				margin-right: 10px;
				min-width: 200px;
			}

			#panel button {
				margin-right: 10px;
				margin-bottom: 5px;
			}

			#search-container {
				display: flex;
				align-items: center;
				margin-right: 15px;
				margin-bottom: 5px;
			}

			#search-input {
				padding: 5px 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				margin-right: 5px;
				min-width: 200px;
			}

			#search-btn {
				padding: 5px 15px;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			#search-btn:hover {
				background-color: #0056b3;
			}

			#settings-btn {
				padding: 5px 15px;
				background-color: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				margin-right: 10px;
			}

			#settings-btn:hover {
				background-color: #1e7e34;
			}

			.status-indicators {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-right: 15px;
			}

			.status-indicator {
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: bold;
			}

			.status-connected {
				background-color: #28a745;
				color: white;
			}

			.status-disconnected {
				background-color: #dc3545;
				color: white;
			}

			iframe {
				border: none;
				position: absolute;
				top: 80px;
				left: 0;
				width: 100%;
				height: calc(100% - 80px);
			}

			#close a {
				font-size: xx-large;
				text-decoration: none;
			}

			/* Modal Styles */
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0,0,0,0.4);
			}

			.modal-content {
				background-color: #fefefe;
				margin: 5% auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
				max-width: 800px;
				border-radius: 8px;
				max-height: 80vh;
				overflow-y: auto;
			}

			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}

			.close:hover {
				color: black;
			}

			.settings-section {
				margin-bottom: 20px;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 5px;
			}

			.settings-section h3 {
				margin-top: 0;
				color: #333;
			}

			.form-group {
				margin-bottom: 15px;
			}

			.form-group label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
			}

			.form-group input, .form-group select {
				width: 100%;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				box-sizing: border-box;
			}

			.btn {
				padding: 8px 16px;
				margin: 5px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			.btn-primary {
				background-color: #007bff;
				color: white;
			}

			.btn-success {
				background-color: #28a745;
				color: white;
			}

			.btn-danger {
				background-color: #dc3545;
				color: white;
			}

			.search-results {
				max-height: 400px;
				overflow-y: auto;
				border: 1px solid #ddd;
				margin-top: 10px;
			}

			.search-result-item {
				padding: 10px;
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.search-result-item:last-child {
				border-bottom: none;
			}

			.search-result-info {
				flex-grow: 1;
			}

			.search-result-title {
				font-weight: bold;
				margin-bottom: 5px;
			}

			.search-result-source {
				color: #666;
				font-size: 12px;
			}

			.search-result-actions {
				display: flex;
				gap: 5px;
			}

			.loading {
				text-align: center;
				padding: 20px;
				color: #666;
			}

			.checkbox-group {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 10px;
			}

			.checkbox-item {
				display: flex;
				align-items: center;
				margin-right: 15px;
			}

			.checkbox-item input {
				margin-right: 5px;
				width: auto;
			}

			.content-type-tabs {
				display: flex;
				margin-bottom: 15px;
			}

			.tab-button {
				flex: 1;
				padding: 10px;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px 4px 0 0;
				cursor: pointer;
				text-align: center;
			}

			.tab-button:hover {
				background-color: #0056b3;
			}

			.tab-button.active {
				background-color: #0056b3;
			}

			.content-settings {
				display: none;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 0 0 4px 4px;
			}

			.content-settings.active {
				display: block;
			}
		</style>
	</head>
	<body>
		<div id="panel">
			<span id="currentPath"></span>
			
			<div id="search-container">
				<input type="text" id="search-input" placeholder="Search all hash lists...">
				<button id="search-btn">Search</button>
			</div>

			<div class="status-indicators">
				<span id="realdebrid-status" class="status-indicator status-disconnected">RD: Disconnected</span>
				<span id="trakt-status" class="status-indicator status-disconnected">Trakt: Disconnected</span>
			</div>

			<button id="settings-btn">‚öôÔ∏è Settings</button>
			<button id="allHashlistsButton">All hash lists</button>
			<button id="previousButton">Previous hash list</button>
			<button id="randomButton">Random hash list</button>
			<button id="nextButton">Next hash list</button>
			<span id="close"><a href="https://debridmediamanager.com/">[X]</a></span>
		</div>

		<iframe src=""></iframe>

		<!-- Settings Modal -->
		<div id="settingsModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Settings</h2>

				<!-- Real-Debrid Settings -->
				<div class="settings-section">
					<h3>üî¥ Real-Debrid Configuration</h3>
					<div class="form-group">
						<label for="rd-api-key">API Key:</label>
						<input type="password" id="rd-api-key" placeholder="Enter your Real-Debrid API key">
						<small>Find your API key at <a href="https://real-debrid.com/apitoken" target="_blank">https://real-debrid.com/apitoken</a></small>
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick="testRealDebridConnection()">Test Connection</button>
						<button class="btn btn-success" onclick="saveRealDebridSettings()">Save</button>
					</div>
				</div>

				<!-- Trakt Settings -->
				<div class="settings-section">
					<h3>üì∫ Trakt Configuration</h3>
					<div class="form-group">
						<button class="btn btn-primary" onclick="connectTrakt()" id="trakt-connect-btn">Connect to Trakt</button>
						<button class="btn btn-danger" onclick="disconnectTrakt()" id="trakt-disconnect-btn" style="display: none;">Disconnect</button>
					</div>
					<div id="trakt-status-info"></div>
				</div>

				<!-- Auto-Add Settings -->
				<div class="settings-section">
					<h3>ü§ñ Auto-Add Configuration</h3>
					<div class="form-group">
						<label>
							<input type="checkbox" id="auto-add-movies"> Auto-add movies from Trakt watchlist to Real-Debrid
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="auto-add-shows"> Auto-add TV shows from Trakt watchlist to Real-Debrid
						</label>
					</div>
					<div class="form-group">
						<button class="btn btn-success" onclick="runAutoAdd()">Run Auto-Add Now</button>
					</div>
				</div>

				<!-- Content Type Tabs -->
				<div class="settings-section">
					<h3>‚öôÔ∏è Content Preferences</h3>
					<div class="content-type-tabs">
						<button class="tab-button active" onclick="switchContentTab('movies')">üé¨ Movies</button>
						<button class="tab-button" onclick="switchContentTab('shows')">üì∫ TV Shows</button>
					</div>

					<!-- Movies Settings -->
					<div id="movies-settings" class="content-settings active">
						<h4>Movie Preferences</h4>
						<div class="form-group">
							<label for="movie-quality-preference">Preferred Quality:</label>
							<select id="movie-quality-preference">
								<option value="2160p">4K (2160p)</option>
								<option value="1080p" selected>1080p</option>
								<option value="720p">720p</option>
								<option value="480p">480p</option>
							</select>
						</div>
						<div class="form-group">
							<label>File Type Preferences:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-remux" checked>
									<label for="movie-prefer-remux">REMUX</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-bluray" checked>
									<label for="movie-prefer-bluray">BluRay</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-web" checked>
									<label for="movie-prefer-web">WEB-DL/WEBRip</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="movie-hdr-preference">HDR Preference:</label>
							<select id="movie-hdr-preference">
								<option value="any">Any (HDR or SDR)</option>
								<option value="sdr-only">SDR Only (No HDR)</option>
								<option value="hdr-preferred">HDR Preferred</option>
								<option value="hdr-only">HDR Only</option>
							</select>
						</div>
						<div class="form-group">
							<label for="movie-max-size">Maximum file size:</label>
							<input type="text" id="movie-max-size" placeholder="e.g., 50GB, 100GB">
						</div>
						<div class="form-group">
							<label>Upgrade Settings:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="movie-auto-upgrade">
									<label for="movie-auto-upgrade">Auto-upgrade movies</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-allow-higher-quality">
									<label for="movie-allow-higher-quality">Allow higher quality</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-delete-old">
									<label for="movie-delete-old">Delete old after upgrade</label>
								</div>
							</div>
						</div>
					</div>

					<!-- TV Shows Settings -->
					<div id="shows-settings" class="content-settings">
						<h4>TV Show Preferences</h4>
						<div class="form-group">
							<label for="show-quality-preference">Preferred Quality:</label>
							<select id="show-quality-preference">
								<option value="2160p">4K (2160p)</option>
								<option value="1080p" selected>1080p</option>
								<option value="720p">720p</option>
								<option value="480p">480p</option>
							</select>
						</div>
						<div class="form-group">
							<label>File Type Preferences:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-remux">
									<label for="show-prefer-remux">REMUX</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-bluray">
									<label for="show-prefer-bluray">BluRay</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-web" checked>
									<label for="show-prefer-web">WEB-DL/WEBRip</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="show-hdr-preference">HDR Preference:</label>
							<select id="show-hdr-preference">
								<option value="any">Any (HDR or SDR)</option>
								<option value="sdr-only" selected>SDR Only (No HDR)</option>
								<option value="hdr-preferred">HDR Preferred</option>
								<option value="hdr-only">HDR Only</option>
							</select>
						</div>
						<div class="form-group">
							<label for="show-max-size">Maximum file size per episode:</label>
							<input type="text" id="show-max-size" placeholder="e.g., 5GB, 10GB">
						</div>
						<div class="form-group">
							<label>Upgrade Settings:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-auto-upgrade">
									<label for="show-auto-upgrade">Auto-upgrade shows</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-allow-higher-quality">
									<label for="show-allow-higher-quality">Allow higher quality</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-delete-old">
									<label for="show-delete-old">Delete old after upgrade</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label>TV Show Specific Options:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-complete-seasons" checked>
									<label for="show-complete-seasons">Prefer complete seasons</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-next-episodes" checked>
									<label for="show-next-episodes">Auto-add next episodes</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-all-seasons">
									<label for="show-all-seasons">Add all seasons for new shows</label>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Global Quality Upgrade Settings -->
				<div class="settings-section">
					<h3>üìà Global Upgrade Configuration</h3>
					<div class="form-group">
						<label>
							<input type="checkbox" id="check-for-upgrades"> Check for quality upgrades during auto-add
						</label>
					</div>
					<div class="form-group">
						<label for="max-upgrade-matches">Max upgrade matches per title:</label>
						<input type="number" id="max-upgrade-matches" value="3" min="1" max="10">
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick="checkUpgradesNow()">Check for Upgrades Now</button>
					</div>
				</div>

				<!-- Search Settings -->
				<div class="settings-section">
					<h3>üîç Search Configuration</h3>
					<div class="form-group">
						<label for="search-limit">Maximum search results:</label>
						<input type="number" id="search-limit" value="50" min="10" max="200">
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="enable-regex" checked> Enable regex search
						</label>
					</div>
				</div>
			</div>
		</div>

		<!-- Search Results Modal -->
		<div id="searchModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Search Results</h2>
				<div id="search-results-container">
					<div class="loading">Searching...</div>
				</div>
			</div>
		</div>

		<script>
			// Initialize API manager
			const apiManager = new APIManager();
			
			// On page load
			window.addEventListener("load", function () {
				let htmlFiles = [];
				let currentIndex = 0;

				const currentPathElement = document.getElementById("currentPath");
				const allHashlistsButton = document.getElementById("allHashlistsButton");
				const previousButton = document.getElementById("previousButton");
				const randomButton = document.getElementById("randomButton");
				const nextButton = document.getElementById("nextButton");
				const iframe = document.querySelector("iframe");

				// Define all functions first, before calling them
				function initializeSettings() {
					loadSettings();
					updateStatusIndicators();
				}

				function loadSettings() {
					const rdApiKey = localStorage.getItem('rd-api-key');
					
					if (rdApiKey) {
						document.getElementById('rd-api-key').value = rdApiKey;
					}
					
					// Load basic settings
					document.getElementById('auto-add-movies').checked = localStorage.getItem('auto-add-movies') === 'true';
					document.getElementById('auto-add-shows').checked = localStorage.getItem('auto-add-shows') === 'true';
					document.getElementById('search-limit').value = localStorage.getItem('search-limit') || '50';
					document.getElementById('enable-regex').checked = localStorage.getItem('enable-regex') !== 'false';
					
					// Load movie preferences
					const moviePrefs = JSON.parse(localStorage.getItem('movie-preferences') || '{}');
					document.getElementById('movie-quality-preference').value = moviePrefs.quality || '1080p';
					document.getElementById('movie-hdr-preference').value = moviePrefs.hdrPreference || 'any';
					document.getElementById('movie-max-size').value = moviePrefs.maxSize || '';
					document.getElementById('movie-auto-upgrade').checked = moviePrefs.autoUpgrade || false;
					document.getElementById('movie-allow-higher-quality').checked = moviePrefs.allowHigherQuality || false;
					document.getElementById('movie-delete-old').checked = moviePrefs.deleteOldAfterUpgrade || false;
					
					// Load movie file types
					const movieFileTypes = moviePrefs.fileTypes || ['remux', 'bluray', 'web'];
					document.getElementById('movie-prefer-remux').checked = movieFileTypes.includes('remux');
					document.getElementById('movie-prefer-bluray').checked = movieFileTypes.includes('bluray');
					document.getElementById('movie-prefer-web').checked = movieFileTypes.includes('web');

					// Load show preferences
					const showPrefs = JSON.parse(localStorage.getItem('show-preferences') || '{}');
					document.getElementById('show-quality-preference').value = showPrefs.quality || '1080p';
					document.getElementById('show-hdr-preference').value = showPrefs.hdrPreference || 'sdr-only';
					document.getElementById('show-max-size').value = showPrefs.maxSize || '';
					document.getElementById('show-auto-upgrade').checked = showPrefs.autoUpgrade || false;
					document.getElementById('show-allow-higher-quality').checked = showPrefs.allowHigherQuality || false;
					document.getElementById('show-delete-old').checked = showPrefs.deleteOldAfterUpgrade || false;
					document.getElementById('show-complete-seasons').checked = showPrefs.completeSeasonsPreferred || false;
					document.getElementById('show-next-episodes').checked = showPrefs.autoAddNextEpisodes || false;
					document.getElementById('show-all-seasons').checked = showPrefs.addAllSeasonsForNewShows || false;
					
					// Initialize Trakt connection status
					updateTraktStatus();
				}

				function updateStatusIndicators() {
					updateRealDebridStatus();
					updateTraktStatus();
				}

				function updateRealDebridStatus() {
					const apiKey = localStorage.getItem('rd-api-key');
					const statusIndicator = document.getElementById('realdebrid-status');
					
					if (!apiKey) {
						statusIndicator.className = 'status-indicator status-disconnected';
						statusIndicator.innerText = 'RD: Disconnected';
						return;
					}
					
					apiManager.testRealDebridConnection(apiKey)
						.then(isConnected => {
							if (isConnected) {
								statusIndicator.className = 'status-indicator status-connected';
								statusIndicator.innerText = 'RD: Connected';
							} else {
								statusIndicator.className = 'status-indicator status-disconnected';
								statusIndicator.innerText = 'RD: Disconnected';
							}
						})
						.catch(error => {
							console.error('Error checking Real-Debrid connection:', error);
							statusIndicator.className = 'status-indicator status-disconnected';
							statusIndicator.innerText = 'RD: Disconnected';
						});
				}

				function updateTraktStatus() {
					const isConnected = localStorage.getItem('trakt-connected') === 'true';
					const statusIndicator = document.getElementById('trakt-status');
					const connectButton = document.getElementById('trakt-connect-btn');
					const disconnectButton = document.getElementById('trakt-disconnect-btn');
					const traktStatusInfo = document.getElementById('trakt-status-info');
					
					if (isConnected) {
						statusIndicator.className = 'status-indicator status-connected';
						statusIndicator.innerText = 'Trakt: Connected';
						connectButton.style.display = 'none';
						disconnectButton.style.display = 'inline-block';
						traktStatusInfo.innerHTML = ''; // Clear any previous error messages
					} else {
						statusIndicator.className = 'status-indicator status-disconnected';
						statusIndicator.innerText = 'Trakt: Disconnected';
						connectButton.style.display = 'inline-block';
						disconnectButton.style.display = 'none';
						
						// Show error message if available
						const errorMessage = localStorage.getItem('trakt-error-message');
						if (errorMessage) {
							traktStatusInfo.innerHTML = `<span style="color: red;">${errorMessage}</span>`;
						} else {
							traktStatusInfo.innerHTML = '';
						}
					}
				}

				function switchContentTab(tab) {
					const moviesSettings = document.getElementById('movies-settings');
					const showsSettings = document.getElementById('shows-settings');
					const movieTabButton = document.querySelector('.tab-button.active');
					const showTabButton = document.querySelector('.tab-button:not(.active)');
					
					if (tab === 'movies') {
						moviesSettings.classList.add('active');
						showsSettings.classList.remove('active');
						movieTabButton.classList.add('active');
						showTabButton.classList.remove('active');
					} else {
						moviesSettings.classList.remove('active');
						showsSettings.classList.add('active');
						movieTabButton.classList.remove('active');
						showTabButton.classList.add('active');
					}
				}

				function updateIframeSrc() {
					if (htmlFiles.length === 0) return;
					if (currentIndex < 0) currentIndex = 0;
					if (currentIndex >= htmlFiles.length) currentIndex = htmlFiles.length - 1;
					
					const file = htmlFiles[currentIndex];
					currentPathElement.innerText = file.path;
					iframe.src = file.url;
				}

				// Event listeners
				allHashlistsButton.addEventListener("click", function () {
					currentIndex = -1;
					htmlFiles = [];
					updateIframeSrc();
				});

				previousButton.addEventListener("click", function () {
					currentIndex--;
					updateIframeSrc();
				});

				randomButton.addEventListener("click", function () {
					currentIndex = Math.floor(Math.random() * htmlFiles.length);
					updateIframeSrc();
				});

				nextButton.addEventListener("click", function () {
					currentIndex++;
					updateIframeSrc();
				});

				// Modal close buttons
				document.querySelectorAll(".close").forEach(closeButton => {
					closeButton.addEventListener("click", function () {
						const modal = closeButton.closest(".modal");
						if (modal) {
							modal.style.display = "none";
						}
					});
				});

				// Outside click closes modal
				window.addEventListener("click", function (event) {
					if (event.target.classList.contains("modal")) {
						event.target.style.display = "none";
					}
				});

				// Initialize settings on load
				initializeSettings();
				
				// Check if we're being redirected from Trakt OAuth
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				const state = urlParams.get('state');
				
				if (code && state) {
					handleTraktRedirect();
				}
			});

			// Enhanced Trakt functions
				async function connectTrakt() {
					// For production, you'd implement proper OAuth flow
					const clientId = prompt('Enter your Trakt Client ID (get one from https://trakt.tv/oauth/applications):');
					if (!clientId) return;

					const redirectUri = encodeURIComponent('https://zero0q.github.io/hashlists');
					const authUrl = `https://trakt.tv/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&state=random-state`;
					
					// Open the authorization URL in a new window
					const authWindow = window.open(authUrl, '_blank');
					
					// Wait for the user to authorize and for the redirect to happen
					const checkInterval = setInterval(() => {
						if (authWindow.closed) {
							clearInterval(checkInterval);
							// The window was closed, assume authorization was completed
							handleTraktRedirect();
						}
					}, 1000);
				}

				function handleTraktRedirect() {
					const urlParams = new URLSearchParams(window.location.search);
					const code = urlParams.get('code');
					const state = urlParams.get('state');
					
					if (!code || !state) {
						alert('Invalid response from Trakt. Please try again.');
						return;
					}
					
					// Store the authorization code temporarily
					localStorage.setItem('trakt-auth-code', code);
					localStorage.setItem('trakt-connected', 'true');
					
					// Clear the URL parameters for a clean interface
					const url = new URL(window.location);
					url.search = '';
					window.history.replaceState({}, document.title, url.toString());
					
					updateTraktStatus();
					alert('Successfully connected to Trakt! You can now use Trakt features.');
				}

				function disconnectTrakt() {
					localStorage.removeItem('trakt-access-token');
					localStorage.removeItem('trakt-refresh-token');
					localStorage.setItem('trakt-connected', 'false');
					
					updateStatusIndicators();
					alert('Successfully disconnected from Trakt.');
				}

				function getUrlParameter(name) {
					const urlParams = new URLSearchParams(window.location.search);
					return urlParams.get(name);
				}
		</script>
	</body>
</html>
