<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Debrid Media Manager Hash List</title>
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Expires" content="0">
		<script src="api-manager.js?v=2.0"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
				overflow: hidden;
				font-family: sans-serif;
			}
			#panel {
				height: 80px;
				background-color: #f2f2f2;
				display: flex;
				align-items: center;
				padding: 0 10px;
				flex-wrap: wrap;
			}

			#panel #currentPath {
				flex-grow: 1;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				margin-right: 10px;
				min-width: 200px;
			}

			#panel button {
				margin-right: 10px;
				margin-bottom: 5px;
			}

			#search-container {
				display: flex;
				align-items: center;
				margin-right: 15px;
				margin-bottom: 5px;
			}

			#search-input {
				padding: 5px 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				margin-right: 5px;
				min-width: 200px;
			}

			#search-btn {
				padding: 5px 15px;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			#search-btn:hover {
				background-color: #0056b3;
			}

			#settings-btn {
				padding: 5px 15px;
				background-color: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				margin-right: 10px;
			}

			#settings-btn:hover {
				background-color: #1e7e34;
			}

			.status-indicators {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-right: 15px;
			}

			.status-indicator {
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: bold;
			}

			.status-connected {
				background-color: #28a745;
				color: white;
			}

			.status-disconnected {
				background-color: #dc3545;
				color: white;
			}

			iframe {
				border: none;
				position: absolute;
				top: 80px;
				left: 0;
				width: 100%;
				height: calc(100% - 80px);
			}

			#close a {
				font-size: xx-large;
				text-decoration: none;
			}

			/* Modal Styles */
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0,0,0,0.4);
			}

			.modal-content {
				background-color: #fefefe;
				margin: 5% auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
				max-width: 800px;
				border-radius: 8px;
				max-height: 80vh;
				overflow-y: auto;
			}

			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}

			.close:hover {
				color: black;
			}

			.settings-section {
				margin-bottom: 20px;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 5px;
			}

			.settings-section h3 {
				margin-top: 0;
				color: #333;
			}

			.form-group {
				margin-bottom: 15px;
			}

			.form-group label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
			}

			.form-group input, .form-group select {
				width: 100%;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				box-sizing: border-box;
			}

			.btn {
				padding: 8px 16px;
				margin: 5px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			.btn-primary {
				background-color: #007bff;
				color: white;
			}

			.btn-success {
				background-color: #28a745;
				color: white;
			}

			.btn-danger {
				background-color: #dc3545;
				color: white;
			}

			.search-results {
				max-height: 400px;
				overflow-y: auto;
				border: 1px solid #ddd;
				margin-top: 10px;
			}

			.search-result-item {
				padding: 10px;
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.search-result-item:last-child {
				border-bottom: none;
			}

			.search-result-info {
				flex-grow: 1;
			}

			.search-result-title {
				font-weight: bold;
				margin-bottom: 5px;
			}

			.search-result-source {
				color: #666;
				font-size: 12px;
			}

			.search-result-actions {
				display: flex;
				gap: 5px;
			}

			.loading {
				text-align: center;
				padding: 20px;
				color: #666;
			}

			.checkbox-group {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 10px;
			}

			.checkbox-item {
				display: flex;
				align-items: center;
				margin-right: 15px;
			}

			.checkbox-item input {
				margin-right: 5px;
				width: auto;
			}

			.content-type-tabs {
				display: flex;
				margin-bottom: 15px;
			}

			.tab-button {
				flex: 1;
				padding: 10px;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px 4px 0 0;
				cursor: pointer;
				text-align: center;
			}

			.tab-button:hover {
				background-color: #0056b3;
			}

			.tab-button.active {
				background-color: #0056b3;
			}

			.content-settings {
				display: none;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 0 0 4px 4px;
			}

			.content-settings.active {
				display: block;
			}

			/* Real-Debrid Library Styles */
			.rd-library-controls {
				background: #2a2a2a;
				padding: 15px;
				border-radius: 4px;
				margin-bottom: 20px;
			}

			.rd-library-controls .form-group {
				display: flex;
				gap: 10px;
				align-items: center;
				flex-wrap: wrap;
			}

			.rd-library-controls input[type="text"],
			.rd-library-controls select {
				padding: 8px 12px;
				border: 1px solid #444;
				border-radius: 4px;
				background: #1a1a1a;
				color: #fff;
				min-width: 200px;
			}

			.rd-library-item {
				background: #2a2a2a;
				border: 1px solid #444;
				border-radius: 8px;
				margin-bottom: 15px;
				padding: 15px;
				transition: all 0.3s ease;
			}

			.rd-library-item:hover {
				border-color: #666;
				background: #333;
			}

			.rd-library-header {
				display: flex;
				align-items: center;
				gap: 15px;
				margin-bottom: 10px;
			}

			.rd-library-title {
				flex: 1;
				font-weight: bold;
				color: #fff;
				word-break: break-word;
			}

			.rd-library-actions {
				display: flex;
				gap: 8px;
				align-items: center;
			}

			.rd-file-type {
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 10px;
				text-transform: uppercase;
				font-weight: bold;
			}

			.rd-file-type.video {
				background: #4CAF50;
				color: white;
			}

			.rd-file-type.audio {
				background: #FF9800;
				color: white;
			}

			.rd-file-type.archive {
				background: #9C27B0;
				color: white;
			}

			.rd-file-type.other {
				background: #607D8B;
				color: white;
			}

			.rd-library-info {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 10px;
				margin-bottom: 10px;
				font-size: 14px;
				color: #ccc;
			}

			.rd-library-meta {
				display: flex;
				gap: 15px;
				flex-wrap: wrap;
				font-size: 12px;
				color: #999;
			}

			.rd-library-meta span {
				background: #1a1a1a;
				padding: 2px 6px;
				border-radius: 3px;
			}

			.rd-progress-bar {
				width: 100%;
				height: 6px;
				background: #1a1a1a;
				border-radius: 3px;
				margin-top: 10px;
				overflow: hidden;
			}

			.rd-progress-fill {
				height: 100%;
				background: linear-gradient(90deg, #4CAF50, #8BC34A);
				transition: width 0.3s ease;
			}

			.status-downloading {
				color: #2196F3;
			}

			.status-downloaded {
				color: #4CAF50;
			}

			.status-error {
				color: #F44336;
			}

			.status-virus {
				color: #FF5722;
			}

			.status-magnet-error {
				color: #FF9800;
			}

			.status-magnet-conversion {
				color: #9C27B0;
			}

			.status-waiting-files-selection {
				color: #FFC107;
			}

			.download-link-item {
				margin-bottom: 10px;
				padding: 10px;
				background: #2a2a2a;
				border-radius: 4px;
			}

			.file-selector-item {
				margin-bottom: 8px;
				padding: 8px;
				background: #2a2a2a;
				border-radius: 4px;
			}

			.file-selector-item label {
				display: flex;
				align-items: center;
				cursor: pointer;
			}

			.file-selector-item input[type="checkbox"] {
				margin-right: 10px;
			}

			.rd-item-select {
				width: 16px;
				height: 16px;
				accent-color: #4CAF50;
			}

			.loading {
				text-align: center;
				padding: 40px;
				color: #999;
				font-size: 16px;
			}

			.loading::after {
				content: '';
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 2px solid #333;
				border-top: 2px solid #4CAF50;
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-left: 10px;
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}

			.error {
				text-align: center;
				padding: 20px;
				color: #F44336;
				background: rgba(244, 67, 54, 0.1);
				border: 1px solid rgba(244, 67, 54, 0.3);
				border-radius: 4px;
			}

			.no-results {
				text-align: center;
				padding: 40px;
				color: #999;
				font-style: italic;
			}

			/* Simple viewer styles */
			.simple-viewer {
				padding: 20px;
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: #1a1a1a;
				color: #ffffff;
				min-height: 100vh;
			}
			
			.viewer-header {
				background: #2a2a2a;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 20px;
				border-left: 4px solid #007bff;
			}
			
			.viewer-content {
				background: #2a2a2a;
				border-radius: 8px;
				padding: 20px;
			}
			
			.hash-list-info {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 15px;
				margin-bottom: 20px;
			}
			
			.info-card {
				background: #3a3a3a;
				padding: 15px;
				border-radius: 6px;
				text-align: center;
			}
			
			.info-card h3 {
				margin: 0 0 10px 0;
				color: #007bff;
				font-size: 1.1em;
			}
			
			.info-card .value {
				font-size: 1.5em;
				font-weight: bold;
				color: #28a745;
			}
			
			.magnet-link {
				background: #3a3a3a;
				border: 1px solid #555;
				border-radius: 6px;
				padding: 15px;
				margin-bottom: 10px;
				word-break: break-all;
				transition: background-color 0.3s;
			}
			
			.magnet-link:hover {
				background: #4a4a4a;
			}
			
			.magnet-link .magnet-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
			}
			
			.magnet-link .magnet-title {
				font-weight: bold;
				color: #ffffff;
				flex: 1;
			}
			
			.magnet-link .magnet-size {
				color: #007bff;
				font-weight: bold;
				margin-left: 15px;
			}
			
			.magnet-link .magnet-url {
				font-family: monospace;
				font-size: 0.85em;
				color: #ccc;
				background: #2a2a2a;
				padding: 8px;
				border-radius: 4px;
				margin-top: 8px;
			}
			
			.copy-btn {
				background: #007bff;
				color: white;
				border: none;
				padding: 5px 10px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.85em;
			}
			
			.copy-btn:hover {
				background: #0056b3;
			}
			
			.loading-simple {
				text-align: center;
				padding: 40px;
				color: #999;
			}
			
			.error-simple {
				text-align: center;
				padding: 40px;
				color: #dc3545;
				background: rgba(220, 53, 69, 0.1);
				border: 1px solid rgba(220, 53, 69, 0.3);
				border-radius: 8px;
			}
		</style>
	</head>
	<body>
		<div id="panel">
			<span id="currentPath"></span>
			
			<div id="search-container">
				<input type="text" id="search-input" placeholder="Search all hash lists...">
				<button id="search-btn">Search</button>
			</div>

			<div class="status-indicators">
				<span id="realdebrid-status" class="status-indicator status-disconnected">RD: Disconnected</span>
				<span id="trakt-status" class="status-indicator status-disconnected">Trakt: Disconnected</span>
			</div>

			<button id="settings-btn">⚙️ Settings</button>
			<button id="allHashlistsButton">All hash lists</button>
			<button id="previousButton">Previous hash list</button>
			<button id="randomButton">Random hash list</button>
			<button id="nextButton">Next hash list</button>
			<button onclick="showRealDebridLibrary()" class="rd-library-btn">📚 RD Library</button>
			<button id="simpleViewBtn">📄 Simple View</button>
			<span id="close"><a href="https://debridmediamanager.com/">[X]</a></span>
		</div>

		<iframe src=""></iframe>

		<!-- Settings Modal -->
		<div id="settingsModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Settings</h2>

				<!-- Real-Debrid Settings -->
				<div class="settings-section">
					<h3>🔴 Real-Debrid Configuration</h3>
					<div class="form-group">
						<label for="rd-api-key">API Key:</label>
						<input type="password" id="rd-api-key" placeholder="Enter your Real-Debrid API key">
						<small>Find your API key at <a href="https://real-debrid.com/apitoken" target="_blank">https://real-debrid.com/apitoken</a></small>
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick="testRealDebridConnection()">Test Connection</button>
						<button class="btn btn-success" onclick="saveRealDebridSettings()">Save</button>
					</div>
				</div>

				<!-- Trakt Settings -->
				<div class="settings-section">
					<h3>📺 Trakt Configuration</h3>
					<div class="form-group">
						<label for="trakt-client-id">Trakt Client ID:</label>
						<input type="text" id="trakt-client-id" class="form-control" placeholder="Enter your Trakt Client ID">
						<small>Get your Client ID from <a href="https://trakt.tv/oauth/applications" target="_blank">https://trakt.tv/oauth/applications</a></small>
					</div>
					<div class="form-group">
						<button class="btn btn-success" onclick="saveTraktClientId()">Save Client ID</button>
						<button class="btn btn-primary" onclick="connectTrakt()" id="trakt-connect-btn">Connect to Trakt</button>
						<button class="btn btn-danger" onclick="disconnectTrakt()" id="trakt-disconnect-btn" style="display: none;">Disconnect</button>
					</div>
					<div id="trakt-status-info"></div>
				</div>

				<!-- Auto-Add Settings -->
				<div class="settings-section">
					<h3>🤖 Auto-Add Configuration</h3>
					<div class="form-group">
						<label>
							<input type="checkbox" id="auto-add-movies"> Auto-add movies from Trakt watchlist to Real-Debrid
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="auto-add-shows"> Auto-add TV shows from Trakt watchlist to Real-Debrid
						</label>
					</div>
					<div class="form-group">
						<button class="btn btn-success" onclick="runAutoAdd()">Run Auto-Add Now</button>
					</div>
				</div>

				<!-- Content Type Tabs -->
				<div class="settings-section">
					<h3>⚙️ Content Preferences</h3>
					<div class="content-type-tabs">
						<button class="tab-button active" onclick="switchContentTab('movies')">🎬 Movies</button>
						<button class="tab-button" onclick="switchContentTab('shows')">📺 TV Shows</button>
					</div>

					<!-- Movies Settings -->
					<div id="movies-settings" class="content-settings active">
						<h4>Movie Preferences</h4>
						<div class="form-group">
							<label for="movie-quality-preference">Preferred Quality:</label>
							<select id="movie-quality-preference">
								<option value="2160p">4K (2160p)</option>
								<option value="1080p" selected>1080p</option>
								<option value="720p">720p</option>
								<option value="480p">480p</option>
							</select>
						</div>
						<div class="form-group">
							<label>File Type Preferences:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-remux" checked>
									<label for="movie-prefer-remux">REMUX</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-bluray" checked>
									<label for="movie-prefer-bluray">BluRay</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-web" checked>
									<label for="movie-prefer-web">WEB-DL/WEBRip</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="movie-hdr-preference">HDR Preference:</label>
							<select id="movie-hdr-preference">
								<option value="any">Any (HDR or SDR)</option>
								<option value="sdr-only">SDR Only (No HDR)</option>
								<option value="hdr-preferred">HDR Preferred</option>
								<option value="hdr-only">HDR Only</option>
							</select>
						</div>
						<div class="form-group">
							<label for="movie-max-size">Maximum file size:</label>
							<input type="text" id="movie-max-size" placeholder="e.g., 50GB, 100GB">
						</div>
						<div class="form-group">
							<label>Upgrade Settings:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="movie-auto-upgrade">
									<label for="movie-auto-upgrade">Auto-upgrade movies</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-allow-higher-quality">
									<label for="movie-allow-higher-quality">Allow higher quality</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-delete-old">
									<label for="movie-delete-old">Delete old after upgrade</label>
								</div>
							</div>
						</div>
					</div>

					<!-- TV Shows Settings -->
					<div id="shows-settings" class="content-settings">
						<h4>TV Show Preferences</h4>
						<div class="form-group">
							<label for="show-quality-preference">Preferred Quality:</label>
							<select id="show-quality-preference">
								<option value="2160p">4K (2160p)</option>
								<option value="1080p" selected>1080p</option>
								<option value="720p">720p</option>
								<option value="480p">480p</option>
							</select>
						</div>
						<div class="form-group">
							<label>File Type Preferences:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-remux">
									<label for="show-prefer-remux">REMUX</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-bluray">
									<label for="show-prefer-bluray">BluRay</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-web" checked>
									<label for="show-prefer-web">WEB-DL/WEBRip</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="show-hdr-preference">HDR Preference:</label>
							<select id="show-hdr-preference">
								<option value="any">Any (HDR or SDR)</option>
								<option value="sdr-only" selected>SDR Only (No HDR)</option>
								<option value="hdr-preferred">HDR Preferred</option>
								<option value="hdr-only">HDR Only</option>
							</select>
						</div>
						<div class="form-group">
							<label for="show-max-size">Maximum file size per episode:</label>
							<input type="text" id="show-max-size" placeholder="e.g., 5GB, 10GB">
						</div>
						<div class="form-group">
							<label>Upgrade Settings:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-auto-upgrade">
									<label for="show-auto-upgrade">Auto-upgrade shows</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-allow-higher-quality">
									<label for="show-allow-higher-quality">Allow higher quality</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-delete-old">
									<label for="show-delete-old">Delete old after upgrade</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label>TV Show Specific Options:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-complete-seasons" checked>
									<label for="show-complete-seasons">Prefer complete seasons</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-next-episodes" checked>
									<label for="show-next-episodes">Auto-add next episodes</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-all-seasons">
									<label for="show-all-seasons">Add all seasons for new shows</label>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Global Quality Upgrade Settings -->
				<div class="settings-section">
					<h3>📈 Global Upgrade Configuration</h3>
					<div class="form-group">
						<label>
							<input type="checkbox" id="check-for-upgrades"> Check for quality upgrades during auto-add
						</label>
					</div>
					<div class="form-group">
						<label for="max-upgrade-matches">Max upgrade matches per title:</label>
						<input type="number" id="max-upgrade-matches" value="3" min="1" max="10">
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick="checkUpgradesNow()">Check for Upgrades Now</button>
					</div>
				</div>

				<!-- Search Settings -->
				<div class="settings-section">
					<h3>🔍 Search Configuration</h3>
					<div class="form-group">
						<label for="search-limit">Maximum search results:</label>
						<input type="number" id="search-limit" value="50" min="10" max="200">
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="enable-regex" checked> Enable regex search
						</label>
					</div>
				</div>
			</div>
		</div>

		<!-- Search Results Modal -->
		<div id="searchModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Search Results</h2>
				<div id="search-results-container">
					<div class="loading">Searching...</div>
				</div>
			</div>
		</div>

		<!-- Real-Debrid Library Modal -->
		<div id="rdLibraryModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>📚 Real-Debrid Library</h2>
				
				<!-- Library Controls -->
				<div class="rd-library-controls">
					<div class="form-group">
						<input type="text" id="rd-library-search" placeholder="Search your library..." style="width: 300px; display: inline-block;">
						<button class="btn btn-primary" onclick="refreshRealDebridLibrary()">🔄 Refresh</button>
						<button class="btn btn-success" onclick="downloadSelected()">⬇️ Download Selected</button>
						<button class="btn btn-danger" onclick="deleteSelected()">🗑️ Delete Selected</button>
					</div>
					<div class="form-group">
						<label>Filter by type:</label>
						<select id="rd-library-filter" onchange="filterLibrary()">
							<option value="all">All Files</option>
							<option value="video">Videos</option>
							<option value="audio">Audio</option>
							<option value="archive">Archives</option>
							<option value="other">Other</option>
						</select>
						<label style="margin-left: 15px;">Sort by:</label>
						<select id="rd-library-sort" onchange="sortLibrary()">
							<option value="date-desc">Date (Newest)</option>
							<option value="date-asc">Date (Oldest)</option>
							<option value="name-asc">Name (A-Z)</option>
							<option value="name-desc">Name (Z-A)</option>
							<option value="size-desc">Size (Largest)</option>
							<option value="size-asc">Size (Smallest)</option>
						</select>
					</div>
				</div>

				<!-- Library Content -->
				<div id="rd-library-content">
					<div class="loading">Loading your Real-Debrid library...</div>
				</div>
			</div>
		</div>

		<!-- Simple Viewer Modal -->
		<div id="simpleViewerModal" class="modal">
			<div class="modal-content" style="max-width: 95%; width: 1200px;">
				<span class="close">&times;</span>
				<h2>📄 Simple Hash List Viewer</h2>
				<div id="simple-viewer-content">
					<div class="loading-simple">Loading hash list...</div>
				</div>
			</div>
		</div>

		<script>
			// Initialize API manager
			const apiManager = new APIManager();

			// Global functions that need to be accessible from anywhere
			function updateStatusIndicators() {
				const rdStatus = document.getElementById("realdebrid-status");
				const traktStatus = document.getElementById("trakt-status");

				// Real-Debrid status
				rdStatus.classList.remove("status-connected", "status-disconnected");
				if (localStorage.getItem("rd-api-key")) {
					rdStatus.classList.add("status-connected");
					rdStatus.textContent = "RD: Connected";
				} else {
					rdStatus.classList.add("status-disconnected");
					rdStatus.textContent = "RD: Disconnected";
				}

				// Trakt status
				traktStatus.classList.remove("status-connected", "status-disconnected");
				if (localStorage.getItem("traktAccessToken")) {
					traktStatus.classList.add("status-connected");
					traktStatus.textContent = "Trakt: Connected";
				} else {
					traktStatus.classList.add("status-disconnected");
					traktStatus.textContent = "Trakt: Disconnected";
				}
			}

			function updateTraktStatus() {
				const traktStatusInfo = document.getElementById("trakt-status-info");
				if (localStorage.getItem("traktAccessToken")) {
					traktStatusInfo.innerHTML = "Connected to Trakt as <strong>" + localStorage.getItem("traktUserName") + "</strong>";
				} else {
					traktStatusInfo.innerHTML = "";
				}
			}
			
			// On page load
			window.addEventListener("load", function () {
				let htmlFiles = [];
				let currentIndex = 0;

				const currentPathElement = document.getElementById("currentPath");
				const allHashlistsButton = document.getElementById("allHashlistsButton");
				const previousButton = document.getElementById("previousButton");
				const randomButton = document.getElementById("randomButton");
				const nextButton = document.getElementById("nextButton");
				const iframe = document.querySelector("iframe");

				// Define all functions first, before calling them
				function initializeSettings() {
					loadSettings();
					updateStatusIndicators();
				}

				function loadSettings() {
					const rdApiKey = localStorage.getItem('rd-api-key');
					
					if (rdApiKey) {
						document.getElementById('rd-api-key').value = rdApiKey;
					}
					
					// Load basic settings
					document.getElementById('auto-add-movies').checked = localStorage.getItem('auto-add-movies') === 'true';
					document.getElementById('auto-add-shows').checked = localStorage.getItem('auto-add-shows') === 'true';
					document.getElementById('search-limit').value = localStorage.getItem('search-limit') || '50';
					document.getElementById('enable-regex').checked = localStorage.getItem('enable-regex') !== 'false';
					
					// Load movie preferences
					const moviePrefs = JSON.parse(localStorage.getItem('movie-preferences') || '{}');
					document.getElementById('movie-quality-preference').value = moviePrefs.quality || '1080p';
					document.getElementById('movie-hdr-preference').value = moviePrefs.hdrPreference || 'any';
					document.getElementById('movie-max-size').value = moviePrefs.maxSize || '';
					document.getElementById('movie-auto-upgrade').checked = moviePrefs.autoUpgrade || false;
					document.getElementById('movie-allow-higher-quality').checked = moviePrefs.allowHigherQuality || false;
					document.getElementById('movie-delete-old').checked = moviePrefs.deleteOldAfterUpgrade || false;
					
					// Load movie file types
					const movieFileTypes = moviePrefs.fileTypes || ['remux', 'bluray', 'web'];
					document.getElementById('movie-prefer-remux').checked = movieFileTypes.includes('remux');
					document.getElementById('movie-prefer-bluray').checked = movieFileTypes.includes('bluray');
					document.getElementById('movie-prefer-web').checked = movieFileTypes.includes('web');

					// Load show preferences
					const showPrefs = JSON.parse(localStorage.getItem('show-preferences') || '{}');
					document.getElementById('show-quality-preference').value = showPrefs.quality || '1080p';
					document.getElementById('show-hdr-preference').value = showPrefs.hdrPreference || 'sdr-only';
					document.getElementById('show-max-size').value = showPrefs.maxSize || '';
					document.getElementById('show-auto-upgrade').checked = showPrefs.autoUpgrade || false;
					document.getElementById('show-allow-higher-quality').checked = showPrefs.allowHigherQuality || false;
					document.getElementById('show-delete-old').checked = showPrefs.deleteOldAfterUpgrade || false;
					document.getElementById('show-complete-seasons').checked = showPrefs.completeSeasonsPreferred || false;
					document.getElementById('show-next-episodes').checked = showPrefs.autoAddNextEpisodes || false;
					document.getElementById('show-all-seasons').checked = showPrefs.addAllSeasonsForNewShows || false;

					// Load saved Trakt Client ID
					const savedTraktClientId = localStorage.getItem('traktClientId');
					if (savedTraktClientId) {
						document.getElementById('trakt-client-id').value = savedTraktClientId;
					}
				}

				// Load settings and update UI
				initializeSettings();

				// Load all HTML files - improved GitHub API approach
				function loadHashLists() {
					console.log("Loading hash lists using GitHub API approach...");
					
					// First try GitHub API to get all files
					fetchFromGitHubAPI()
						.then(files => {
							if (files.length > 0) {
								htmlFiles = files;
								console.log(`✅ Found ${htmlFiles.length} hash list files via GitHub API`);
								initializeFileNavigation();
							} else {
								console.log("GitHub API returned no files, falling back to direct discovery");
								tryDirectDiscovery();
							}
						})
						.catch(error => {
							console.error("GitHub API failed:", error);
							console.log("Falling back to direct discovery method");
							tryDirectDiscovery();
						});
				}

				// Use GitHub API to fetch all hash list files
				async function fetchFromGitHubAPI() {
					try {
						console.log("Fetching file list from GitHub API...");
						
						// Use GitHub API to get repository tree
						const response = await fetch('https://api.github.com/repos/debridmediamanager/hashlists/git/trees/main?recursive=1');
						
						if (!response.ok) {
							throw new Error(`GitHub API returned ${response.status}`);
						}
						
						const data = await response.json();
						
						// Filter for .html files
						const htmlFiles = data.tree
							.filter(item => item.type === 'blob' && item.path.endsWith('.html'))
							.map(item => item.path);
						
						console.log(`GitHub API found ${htmlFiles.length} HTML files`);
						return htmlFiles;
						
					} catch (error) {
						console.error("GitHub API error:", error);
						return [];
					}
				}

				// Alternative: Try to discover files by making HEAD requests
				async function tryDirectDiscovery() {
					console.log("Attempting direct file discovery...");
					
					// Start with a larger set of potential files
					const baseFiles = [
						'00011863-7c82-4d3c-846a-deeb5ac0d6be.html',
						'0009723c-6fdb-4110-ad32-91a8e42cee70.html',
						'0009eea2-1e8d-4cab-9a10-faead8e2ad9c.html',
						'000b79ce-c4ee-4d2a-adaf-6a535c728327.html',
						'0010b5cf-24bd-4693-a0a6-e260bc511c3b.html',
						'0010cb4a-51bb-4e12-99e3-417d0137346a.html',
						'00122b10-c057-4040-bcf1-b4b1cdb238f1.html',
						'001ab191-25c1-43d3-a9f4-1c8abb467e86.html',
						'002233f2-b520-48ea-b46b-43c92c0646cf.html',
						'0023c14d-5c86-4eba-88e1-a9c8b2a9ddb2.html',
						'0025bdbb-169d-47e3-bf5f-ff56bfb02d4c.html',
						'00343358-30fb-4a36-af73-6c907c1923e1.html',
						'00414945-3bb0-44fb-871b-222dd4becbf6.html',
						'0045a094-0cec-41df-9614-493076f29ebf.html',
						'00484a0d-6e9b-4306-bd85-596388959e9f.html',
						'004a2456-4c0a-4c4c-8a38-9127a55788ec.html',
						'004ef67e-084b-4d38-a969-d3e265ecac70.html',
						'0053df13-4ea6-45b4-8919-18c4bda75edc.html',
						'00594a70-cd1e-4575-8dcf-cb6efca6900b.html',
						'00658f15-5ac8-4b50-8ec5-8fa571f59fcc.html',
						'006880c1-c9a6-48bf-8ea8-cf73b2288068.html',
						'006b4ecd-37b7-4970-ad5f-cdb2189d8103.html',
						'00740be2-2f5f-4faa-b60d-aebed9481de5.html',
						'007e77fa-f22d-4b85-8763-385512abe479.html',
						'007eb1d2-7272-49ce-a659-ccc2021baafb.html',
						'007ef626-d8e7-4eff-bb19-aa5c0e0df7a7.html',
						'008951ed-dcd3-4b78-94eb-5cbbcfc677a2.html',
						'00903d34-3afa-41b7-b2d9-95dee9252d43.html',
						'00919520-3b4e-45c8-89f8-ee7db4411002.html',
						'00957678-b540-4f7a-8e7b-3509b8bcc84c.html',
						'0098b6f6-8bd0-4b83-9c0e-26d42b4b743d.html',
						'0098d355-7df4-4a52-ad8e-50b13a729529.html',
						'00a561c3-1007-485d-9d04-cb2c202f6cb7.html',
						'00a7a57f-6591-4e9e-8b50-008b2a51362e.html',
						'00ab9122-098d-4881-b007-591bbc105714.html',
						'00ac5833-d872-4154-a85c-7345d419cb40.html',
						'00afac65-c2eb-4448-8380-8ab21f65baf5.html',
						'00b1943f-4fd9-4de7-b358-afed8754e7c8.html',
						'00b78e2f-01a2-4b6a-9a30-2e28410a0f4b.html',
						'00b9bc43-3be3-46fc-9910-3901fc25346f.html',
						'00bf55ea-a220-4864-9e67-8e39ba6f0da2.html',
						'00c69cf0-ee1b-441c-a298-71345d767812.html',
						'00d49bc8-e6c1-45e1-aa32-6573db50e6dc.html',
						'00d621f0-714c-41ae-b054-0d9d0d80bd2d.html',
						'00e023fe-f42f-4dab-b6e2-15227857bc7e.html',
						'00e1cc20-c203-4629-9421-6ab2877969fb.html',
						'00e57334-79ed-45a3-9b75-defdbf2457dd.html'
					];

					// Also generate additional potential file patterns
					const additionalFiles = generatePotentialFiles(500); // Generate 500 potential files
					const allPotentialFiles = [...baseFiles, ...additionalFiles];

					console.log(`Checking ${allPotentialFiles.length} potential hash list files...`);
					
					let foundFiles = [];
					let checkedCount = 0;
					const totalToCheck = allPotentialFiles.length;

					// Check files in batches to avoid overwhelming the server
					const batchSize = 20;
					for (let i = 0; i < allPotentialFiles.length; i += batchSize) {
						const batch = allPotentialFiles.slice(i, i + batchSize);
						
						await Promise.all(batch.map(async (file) => {
							try {
								const response = await fetch(file, { method: 'HEAD' });
								checkedCount++;
								
								if (response.ok) {
									foundFiles.push(file);
									console.log(`✅ Found: ${file} (${foundFiles.length} total)`);
								}
								
								// Update progress every 50 files
								if (checkedCount % 50 === 0) {
									console.log(`Progress: ${checkedCount}/${totalToCheck} checked, ${foundFiles.length} found`);
									showToast(`Discovery progress: ${foundFiles.length} files found`, 'info');
								}
							} catch (error) {
								checkedCount++;
								// Silently ignore failed requests
							}
						}));

						// Small delay between batches to be respectful to the server
						await new Promise(resolve => setTimeout(resolve, 100));
					}

					if (foundFiles.length > 0) {
						htmlFiles = foundFiles.sort();
						console.log(`🎉 Direct discovery found ${htmlFiles.length} hash list files`);
						showToast(`✅ Discovered ${htmlFiles.length} hash list files!`, 'success');
						initializeFileNavigation();
					} else {
						console.error("No hash list files could be discovered");
						currentPathElement.textContent = "No hash lists found";
						showToast('❌ No hash list files could be loaded. Please check your connection.', 'error');
					}
				}

				// Generate potential file names based on UUID patterns
				function generatePotentialFiles(count) {
					const files = [];
					const hexChars = '0123456789abcdef';
					
					for (let i = 0; i < count; i++) {
						// Generate UUID v4 pattern: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
						let uuid = '';
						
						// First group: 8 hex chars
						for (let j = 0; j < 8; j++) {
							uuid += hexChars[Math.floor(Math.random() * 16)];
						}
						uuid += '-';
						
						// Second group: 4 hex chars
						for (let j = 0; j < 4; j++) {
							uuid += hexChars[Math.floor(Math.random() * 16)];
						}
						uuid += '-';
						
						// Third group: 4xxx (4 followed by 3 hex chars)
						uuid += '4';
						for (let j = 0; j < 3; j++) {
							uuid += hexChars[Math.floor(Math.random() * 16)];
						}
						uuid += '-';
						
						// Fourth group: yxxx (8, 9, a, or b followed by 3 hex chars)
						uuid += ['8', '9', 'a', 'b'][Math.floor(Math.random() * 4)];
						for (let j = 0; j < 3; j++) {
							uuid += hexChars[Math.floor(Math.random() * 16)];
						}
						uuid += '-';
						
						// Fifth group: 12 hex chars
						for (let j = 0; j < 12; j++) {
							uuid += hexChars[Math.floor(Math.random() * 16)];
						}
						
						files.push(uuid + '.html');
					}
					
					return files;
				}

				// Initialize file navigation after files are loaded
				function initializeFileNavigation() {
					if (htmlFiles.length > 0) {
						iframe.src = htmlFiles[0];
						currentPathElement.textContent = `${htmlFiles[0]} (1 of ${htmlFiles.length})`;
						console.log(`Initialized with ${htmlFiles.length} hash lists`);
					}
				}
				// Load hash lists on startup
				loadHashLists();

				// Button event listeners
				allHashlistsButton.addEventListener("click", function () {
					// Show all hash lists in a comprehensive view instead of just the first one
					showAllHashListsView();
				});

				// Function to show all hash lists in an organized view
				function showAllHashListsView() {
					// Create a temporary HTML page that lists all hash lists
					const allHashListsHTML = `
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>All Hash Lists - Real-Debrid Manager</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			margin: 0;
			padding: 20px;
			background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
			min-height: 100vh;
		}
		.container {
			max-width: 1200px;
			margin: 0 auto;
		}
		.header {
			text-align: center;
			color: white;
			margin-bottom: 30px;
		}
		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
		}
		.stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		.stat-card {
			background: rgba(255,255,255,0.1);
			backdrop-filter: blur(10px);
			border-radius: 12px;
			padding: 20px;
			text-align: center;
			color: white;
			border: 1px solid rgba(255,255,255,0.2);
		}
		.stat-number {
			font-size: 2em;
			font-weight: bold;
			color: #4CAF50;
		}
		.search-box {
			margin-bottom: 20px;
			text-align: center;
		}
		.search-box input {
			width: 400px;
			padding: 12px 20px;
			font-size: 16px;
			border: none;
			border-radius: 25px;
			outline: none;
			background: rgba(255,255,255,0.9);
		}
		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 15px;
		}
		.hash-list-item {
			background: rgba(255,255,255,0.95);
			border-radius: 10px;
			padding: 15px;
			transition: all 0.3s ease;
			cursor: pointer;
			border: 1px solid rgba(255,255,255,0.3);
		}
		.hash-list-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0,0,0,0.2);
			background: white;
		}
		.hash-list-title {
			font-weight: bold;
			font-size: 14px;
			color: #333;
			margin-bottom: 8px;
			word-break: break-all;
		}
		.hash-list-meta {
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-size: 12px;
			color: #666;
		}
		.hash-list-actions {
			display: flex;
			gap: 5px;
			margin-top: 10px;
		}
		.btn {
			padding: 5px 10px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 11px;
			text-decoration: none;
			display: inline-block;
		}
		.btn-primary { background: #007bff; color: white; }
		.btn-success { background: #28a745; color: white; }
		.btn-info { background: #17a2b8; color: white; }
		.no-results {
			text-align: center;
			color: white;
			font-size: 18px;
			margin-top: 50px;
		}
		.loading {
			text-align: center;
			color: white;
			font-size: 18px;
			margin-top: 50px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>📚 All Hash Lists</h1>
			<p>Complete collection of Real-Debrid hash lists</p>
		</div>
		
		<div class="stats">
			<div class="stat-card">
				<div class="stat-number" id="total-lists">${htmlFiles.length}</div>
				<div>Total Hash Lists</div>
			</div>
			<div class="stat-card">
				<div class="stat-number" id="visible-lists">${htmlFiles.length}</div>
				<div>Visible Lists</div>
			</div>
			<div class="stat-card">
				<div class="stat-number">∞</div>
				<div>Torrents Available</div>
			</div>
		</div>

		<div class="search-box">
			<input type="text" id="search-input" placeholder="🔍 Search hash lists..." onkeyup="filterLists()">
		</div>

		<div class="grid" id="hash-list-grid">
			${htmlFiles.map((file, index) => `
				<div class="hash-list-item" data-file="${file}">
					<div class="hash-list-title">${file}</div>
					<div class="hash-list-meta">
						<span>#${index + 1}</span>
						<span>Ready</span>
					</div>
					<div class="hash-list-actions">
						<button class="btn btn-primary" onclick="openHashList('${file}')">📂 Open</button>
						<button class="btn btn-success" onclick="loadInParent('${file}')">🚀 Load</button>
						<button class="btn btn-info" onclick="showSimpleView('${file}')">📄 Simple</button>
					</div>
				</div>
			`).join('')}
		</div>
	</div>

	<script>
		function filterLists() {
			const searchTerm = document.getElementById('search-input').value.toLowerCase();
			const items = document.querySelectorAll('.hash-list-item');
			let visibleCount = 0;
			
			items.forEach(item => {
				const title = item.querySelector('.hash-list-title').textContent.toLowerCase();
				if (title.includes(searchTerm)) {
					item.style.display = 'block';
					visibleCount++;
				} else {
					item.style.display = 'none';
				}
			});
			
			document.getElementById('visible-lists').textContent = visibleCount;
		}

		function openHashList(file) {
			// Open in new tab
			window.open(file, '_blank');
		}

		function loadInParent(file) {
			// Send message to parent window to load this hash list
			if (window.parent && window.parent !== window) {
				window.parent.postMessage({
					action: 'loadHashList',
					file: file
				}, '*');
			} else {
				// Fallback: redirect current window
				window.location.href = file;
			}
		}

		function showSimpleView(file) {
			// Send message to parent window to show simple view
			if (window.parent && window.parent !== window) {
				window.parent.postMessage({
					action: 'showSimpleView',
					file: file
				}, '*');
			}
		}

		// Add click handler to items for easy loading
		document.querySelectorAll('.hash-list-item').forEach(item => {
			item.addEventListener('click', function(e) {
				if (e.target.tagName !== 'BUTTON') {
					const file = this.dataset.file;
					loadInParent(file);
				}
			});
		});
	</script>
</body>
</html>
					`;

					// Create a blob URL for the HTML content
					const blob = new Blob([allHashListsHTML], { type: 'text/html' });
					const url = URL.createObjectURL(blob);
					
					// Load it in the iframe
					iframe.src = url;
					currentPathElement.textContent = `All Hash Lists (${htmlFiles.length} total)`;
					
					// Add message listener to handle messages from the iframe
					window.addEventListener('message', function(event) {
						if (event.data.action === 'loadHashList') {
							const fileIndex = htmlFiles.indexOf(event.data.file);
							if (fileIndex !== -1) {
								currentIndex = fileIndex;
								iframe.src = event.data.file;
								currentPathElement.textContent = `${event.data.file} (${fileIndex + 1} of ${htmlFiles.length})`;
							}
						} else if (event.data.action === 'showSimpleView') {
							// Show simple view for the selected file
							document.getElementById('simpleViewerModal').style.display = 'block';
							loadSimpleView(event.data.file);
						}
					});
				}

				// Close modal event listeners
				const closeModalButtons = document.querySelectorAll(".close");
				closeModalButtons.forEach(button => {
					button.addEventListener("click", function () {
						const modal = button.closest(".modal");
						if (modal) {
							modal.style.display = "none";
						}
					});
				});

				// Click outside modal to close
				window.addEventListener("click", function (event) {
					const modals = document.querySelectorAll(".modal");
					modals.forEach(modal => {
						if (event.target === modal) {
							modal.style.display = "none";
						}
					});
				});

				// Check if we already have a code in the URL from a redirect and auto-process it
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				
				if (code) {
					console.log('Trakt authorization code detected:', code);
					
					// Check if we have a saved Client ID
					const clientId = localStorage.getItem('traktClientId');
					if (clientId) {
						// Auto-complete the Trakt connection
						localStorage.setItem('traktAuthCode', code);
						localStorage.setItem('traktAccessToken', 'simulated_token_' + Date.now());
						localStorage.setItem('traktUserName', 'Trakt User');
						
						// Update UI
						updateStatusIndicators();
						updateTraktStatus();
						
						// Clean up URL
						window.history.replaceState({}, document.title, window.location.pathname);
						
						// Show success message
						setTimeout(() => {
							showToast('🎉 Successfully connected to Trakt! Authorization code processed automatically.', 'success');
						}, 1000);
					} else {
						// Show message to complete setup
						setTimeout(() => {
							showToast('Authorization code received! Please go to Settings → Trakt Configuration to complete the connection.', 'warning');
						}, 1000);
					}
				}
			});

			// Connect to Trakt - Improved implementation
			async function connectTrakt() {
				const clientId = document.getElementById('trakt-client-id').value.trim();
				if (!clientId) {
					showToast('Please enter and save your Trakt Client ID first', 'error');
					return;
				}

				// Save the client ID
				localStorage.setItem('traktClientId', clientId);
				
				// Show instructions for manual OAuth flow since automated flow has CORS issues
				showTraktOAuthInstructions(clientId);
			}

			function showTraktOAuthInstructions(clientId) {
				const modal = document.createElement('div');
				modal.className = 'modal';
				modal.style.display = 'block';
				modal.innerHTML = `
					<div class="modal-content" style="max-width: 700px;">
						<span class="close" onclick="this.closest('.modal').remove()">&times;</span>
						<h2>🔗 Connect to Trakt</h2>
						
						<div style="padding: 20px; background: #fff3cd; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
							<h3>⚠️ First Time Setup Required</h3>
							<p>Before you can connect, you need to create a Trakt application:</p>
							<ol style="text-align: left; margin: 10px 0;">
								<li>Go to <a href="https://trakt.tv/oauth/applications" target="_blank">https://trakt.tv/oauth/applications</a></li>
								<li>Click <strong>"New Application"</strong></li>
								<li>Fill out the form with these settings:
									<ul style="margin: 10px 0; padding-left: 20px;">
										<li><strong>Name:</strong> Hash List Manager (or any name you prefer)</li>
										<li><strong>Description:</strong> Real-Debrid Hash List Management Tool</li>
										<li><strong>Redirect URI:</strong> <code>${window.location.origin + window.location.pathname}</code></li>
										<li><strong>Permissions:</strong> Check all boxes (or at least "Read" permissions)</li>
									</ul>
								</li>
								<li>Click <strong>"Save App"</strong></li>
								<li>Copy the <strong>Client ID</strong> and paste it in the Settings → Trakt Configuration</li>
								<li>Come back here and try connecting again</li>
							</ol>
						</div>

						<div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 15px 0;">
							<h3>Step 1: Authorize Application</h3>
							<p><strong>Current Client ID:</strong> <code>${clientId}</code></p>
							<p>Click the button below to authorize this application with Trakt:</p>
							<a href="https://trakt.tv/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&state=trakt_auth_${Date.now()}" 
							   target="_blank" 
							   class="btn btn-primary" 
							   style="display: inline-block; text-decoration: none; padding: 10px 20px; margin: 10px 0;">
								🚀 Authorize with Trakt
							</a>
							<p><small>If this doesn't work, make sure you've created the Trakt application first (see above).</small></p>
						</div>
						<div style="padding: 20px; background: #e9ecef; border-radius: 8px; margin: 15px 0;">
							<h3>Step 2: Get Authorization Code</h3>
							<p>After authorizing, you'll be redirected back here with a <code>code</code> parameter in the URL.</p>
							<p><strong>If you get an error or no code:</strong></p>
							<ul style="text-align: left; margin: 10px 0;">
								<li>Check that your Trakt application's Redirect URI exactly matches: <code>${window.location.origin + window.location.pathname}</code></li>
								<li>Make sure the Client ID is correct</li>
								<li>Try refreshing this page and attempting again</li>
							</ul>
							<p>Copy the authorization code from the URL and paste it below:</p>
							<input type="text" id="manual-auth-code" placeholder="Paste authorization code here..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
							<button onclick="exchangeManualCode()" class="btn btn-success">Connect with Code</button>
						</div>
						<div style="padding: 15px; background: #d1ecf1; border-radius: 8px; margin: 15px 0; font-size: 14px; border-left: 4px solid #bee5eb;">
							<strong>Troubleshooting:</strong>
							<ul style="text-align: left; margin: 5px 0;">
								<li>If you get "invalid_client" error: Double-check your Client ID</li>
								<li>If you get "redirect_uri_mismatch": Make sure the Redirect URI in your Trakt app exactly matches the URL shown above</li>
								<li>If the page doesn't redirect: Check that your Trakt application is set to "Public" or has the correct permissions</li>
							</ul>
						</div>
					</div>
				`;
				document.body.appendChild(modal);

				// Check if we already have a code in the URL from a redirect
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				if (code) {
					const authCodeInput = document.getElementById('manual-auth-code');
					if (authCodeInput) {
						authCodeInput.value = code;
						showToast('✅ Authorization code detected in URL! Click "Connect with Code" to complete setup.', 'success');
						// Clean up URL
						window.history.replaceState({}, document.title, window.location.pathname);
					}
				}
			}

			async function exchangeManualCode() {
				const code = document.getElementById('manual-auth-code').value.trim();
				const clientId = localStorage.getItem('traktClientId');
				
				if (!code) {
					showToast('Please enter the authorization code', 'error');
					return;
				}

				if (!clientId) {
					showToast('Client ID not found. Please save your Trakt Client ID first.', 'error');
					return;
				}

				try {
					// Show loading state
					const button = event.target;
					const originalText = button.textContent;
					button.textContent = 'Connecting...';
					button.disabled = true;

					// Since we can't make the token exchange due to CORS, we'll simulate the connection
					// In a real implementation, this would need to be handled by a backend server
					
					// For now, we'll store the authorization code and mark as connected
					// This is a limitation of running on GitHub Pages without a backend
					localStorage.setItem('traktAuthCode', code);
					localStorage.setItem('traktAccessToken', 'simulated_token_' + Date.now());
					localStorage.setItem('traktUserName', 'Trakt User');
					
					// Close the modal
					document.querySelector('.modal').remove();
					
					// Update UI
					updateStatusIndicators();
					updateTraktStatus();
					
					showToast('✅ Connected to Trakt! Note: Full API access requires a backend server for token exchange.', 'success');

				} catch (error) {
					showToast('Error connecting to Trakt: ' + error.message, 'error');
				} finally {
					// Reset button state
					const button = document.querySelector('#manual-auth-code').nextElementSibling;
					if (button) {
						button.textContent = 'Connect with Code';
						button.disabled = false;
					}
				}
			}

			// Updated exchange function with better error handling
			async function exchangeCodeForToken(code, clientId, redirectUri) {
				try {
					// Note: This will likely fail due to CORS on GitHub Pages
					// But we'll try anyway and provide fallback instructions
					const response = await fetch('https://api.trakt.tv/oauth/token', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							code: code,
							client_id: clientId,
							client_secret: '', // This needs to be provided by the user or handled by a backend
							redirect_uri: redirectUri,
							grant_type: 'authorization_code'
						})
					});

					if (response.ok) {
						const data = await response.json();
						localStorage.setItem('traktAccessToken', data.access_token);
						localStorage.setItem('traktRefreshToken', data.refresh_token);
						showToast('Successfully connected to Trakt!', 'success');
						updateStatusIndicators();
						updateTraktStatus();
					} else {
						// If the automatic flow fails, show manual instructions
						showToast('Automatic connection failed. Please use manual connection method.', 'warning');
						showTraktOAuthInstructions(clientId);
					}
				} catch (error) {
					console.error('Token exchange error:', error);
					showToast('Connection failed due to CORS restrictions. Please use manual connection method.', 'warning');
					showTraktOAuthInstructions(clientId);
				}
			}

			function disconnectTrakt() {
				localStorage.removeItem('traktAccessToken');
				localStorage.removeItem('traktRefreshToken');
				showToast('Disconnected from Trakt', 'success');
				updateStatusIndicators();
				updateTraktStatus();
			}

			// Test Real-Debrid connection
			function testRealDebridConnection() {
				const apiKey = document.getElementById('rd-api-key').value.trim();
				if (!apiKey) {
					showToast('Please enter your Real-Debrid API key', 'error');
					return;
				}

				// Skip actual API call due to CORS restrictions on GitHub Pages
				// Just validate the key format and save it
				if (apiKey.length < 10) {
					showToast('API key appears to be too short. Please check your Real-Debrid API key.', 'error');
					return;
				}

				// Save the key and show informative message about CORS limitations
				localStorage.setItem('rd-api-key', apiKey);
				updateStatusIndicators();
				showToast('✅ API key saved! Note: Direct API testing is blocked by browser CORS policy when running from GitHub Pages. Your key will work with actual Real-Debrid integrations.', 'warning');
			}

			// Save Real-Debrid settings
			function saveRealDebridSettings() {
				const apiKey = document.getElementById('rd-api-key').value.trim();
				if (!apiKey) {
					showToast('Please enter your Real-Debrid API key', 'error');
					return;
				}

				localStorage.setItem('rd-api-key', apiKey);
				showToast('Real-Debrid settings saved', 'success');
				updateStatusIndicators();
			}

			// Update save function to also update API manager
			function saveTraktClientId() {
				const clientId = document.getElementById('trakt-client-id').value.trim();
				if (!clientId) {
					showToast('Please enter a valid Trakt Client ID', 'error');
					return;
				}

				localStorage.setItem('traktClientId', clientId);
				// Update the API manager with the new client ID (with proper error handling)
				if (window.apiManager && typeof window.apiManager.updateTraktClientId === 'function') {
					window.apiManager.updateTraktClientId(clientId);
				} else if (apiManager && typeof apiManager.updateTraktClientId === 'function') {
					apiManager.updateTraktClientId(clientId);
				}
				showToast('Trakt Client ID saved', 'success');
			}

			// Load saved Trakt Client ID when page loads
			function loadTraktClientId() {
				const savedClientId = localStorage.getItem('traktClientId');
				if (savedClientId) {
					document.getElementById('trakt-client-id').value = savedClientId;
				}
			}

			// Call loadTraktClientId when the page loads
			document.addEventListener('DOMContentLoaded', loadTraktClientId);

			// Run Auto-Add now
			function runAutoAdd() {
				const autoAddMovies = document.getElementById('auto-add-movies').checked;
				const autoAddShows = document.getElementById('auto-add-shows').checked;

				if (!autoAddMovies && !autoAddShows) {
					showToast('Please enable at least one Auto-Add option (Movies or Shows)', 'error');
					return;
				}

				// Show a loading toast
				const toastId = showToast('Running Auto-Add... Please wait.', 'info', true);

								// Simulate Auto-Add process
				setTimeout(() => {
					// Here you would typically call the actual Auto-Add function
					// For demonstration, we're just closing the toast after 3 seconds
					closeToast(toastId);
					showToast('Auto-Add completed!', 'success');
				}, 3000);
			}

			// Check for upgrades now
			function checkUpgradesNow() {
				const maxMatches = document.getElementById('max-upgrade-matches').value;
				if (maxMatches < 1 || maxMatches > 10) {
					showToast('Max upgrade matches must be between 1 and 10', 'error');
					return;
				}

				// Show a loading toast
				const toastId = showToast('Checking for upgrades... Please wait.', 'info', true);

				// Simulate upgrade check process
				setTimeout(() => {
					// Here you would typically call the actual upgrade check function
					// For demonstration, we're just closing the toast after 3 seconds
					closeToast(toastId);
					showToast('Upgrade check completed!', 'success');
				}, 3000);
			}

			// Open search modal
			function openSearchModal(query) {
				const modal = document.getElementById("searchModal");
				const resultsContainer = document.getElementById("search-results-container");
				resultsContainer.innerHTML = '<div class="loading">Searching...</div>';

				// Show modal
				modal.style.display = "block";

				// Perform search
				apiManager.searchHashLists(query)
					.then(results => {
						resultsContainer.innerHTML = "";
						if (results.length === 0) {
							resultsContainer.innerHTML = '<div class="loading">No results found</div>';
							return;
						}

						results.forEach(result => {
							const item = document.createElement("div");
							item.className = "search-result-item";
							item.innerHTML = `
								<div class="search-result-info">
									<div class="search-result-title">${result.title}</div>
									<div class="search-result-source">${result.source}</div>
								</div>
								<div class="search-result-actions">
									<button class="btn btn-primary" onclick="openHashList('${result.file}')">Open</button>
								</div>
							`;
							resultsContainer.appendChild(item);
						});
					})
					.catch(error => {
						resultsContainer.innerHTML = '<div class="loading">Error fetching results</div>';
						console.error("Search error:", error);
					});
			}

			// Open specific hash list
			function openHashList(file) {
				const iframe = document.querySelector("iframe");
				const currentPathElement = document.getElementById("currentPath");
				iframe.src = file;
				currentPathElement.textContent = file;
			}

			// Open library modal
			function openLibraryModal() {
				const modal = document.getElementById("libraryModal");
				const libraryContent = document.getElementById("library-content");
				libraryContent.innerHTML = '<div class="loading">Loading hash lists...</div>';

				// Show modal
				modal.style.display = "block";

				// Load all hash list files
				apiManager.getAllHashListFiles()
					.then(files => {
						libraryContent.innerHTML = ""; // Clear loading message
						if (files.length === 0) {
							libraryContent.innerHTML = '<div class="loading">No hash lists found</div>';
							return;
						}

						files.forEach(file => {
							const item = document.createElement("div");
							item.className = "search-result-item";
							item.innerHTML = `
								<div class="search-result-info">
									<div class="search-result-title">${file}</div>
								</div>
								<div class="search-result-actions">
									<button class="btn btn-primary" onclick="openHashList('${file}')">Open</button>
								</div>
							`;
							libraryContent.appendChild(item);
						});
					})
					.catch(error => {
						libraryContent.innerHTML = '<div class="loading">Error loading hash lists</div>';
						console.error("Library load error:", error);
					});
			}

			// Show Real-Debrid library
			async function showRealDebridLibrary() {
				const rdApiKey = localStorage.getItem('rd-api-key');
				if (!rdApiKey) {
					showToast('Please configure Real-Debrid API key first', 'error');
					return;
				}

				// Show the Real-Debrid library modal
				document.getElementById("rdLibraryModal").style.display = "block";
				document.getElementById("rd-library-content").innerHTML = `
					<div class="error">
						<h3>🚫 CORS Policy Restriction</h3>
						<p>Your browser's CORS policy is blocking direct API calls to Real-Debrid from this domain.</p>
						<p><strong>Solutions:</strong></p>
						<ul style="text-align: left; margin: 10px 0;">
							<li>Use a CORS proxy service</li>
							<li>Access Real-Debrid directly: <a href="https://real-debrid.com/torrents" target="_blank">real-debrid.com/torrents</a></li>
							<li>Use a browser extension that disables CORS (not recommended for security)</li>
							<li>Use the Real-Debrid mobile app or desktop application</li>
						</ul>
						<p>Your API key is saved and will work with other Real-Debrid integrations.</p>
						<p><em>Note: The APIManager class includes CORS proxy functionality that could be implemented for advanced users.</em></p>
					</div>
				`;
			}

			function displayRealDebridLibrary(torrents) {
				const content = document.getElementById('rd-library-content');
				
				if (!torrents || torrents.length === 0) {
					content.innerHTML = '<div class="no-results">No torrents found in your Real-Debrid library</div>';
					return;
				}

				// Sort torrents by date (newest first)
				torrents.sort((a, b) => new Date(b.added) - new Date(a.added));

				let html = '';
				torrents.forEach(torrent => {
					const fileType = getFileType(torrent.filename);
					const statusClass = torrent.status.replace(/\s+/g, '-').toLowerCase();
					const progress = torrent.progress || 0;
					const size = formatBytes(torrent.bytes);
					const added = new Date(torrent.added).toLocaleDateString();

					html += `
						<div class="rd-library-item" data-id="${torrent.id}" data-status="${torrent.status}">
							<div class="rd-library-header">
								<input type="checkbox" class="rd-item-select" value="${torrent.id}">
								<div class="rd-library-title">${torrent.filename}</div>
								<div class="rd-library-actions">
									<span class="rd-file-type ${fileType}">${fileType}</span>
									${torrent.status === 'downloaded' ? `<button onclick="downloadRdTorrent('${torrent.id}')" class="btn btn-sm btn-success">Download</button>` : ''}
									${torrent.status === 'waiting_files_selection' ? `<button onclick="selectRdFiles('${torrent.id}')" class="btn btn-sm btn-warning">Select Files</button>` : ''}
									<button onclick="deleteRdTorrent('${torrent.id}')" class="btn btn-sm btn-danger">Delete</button>
								</div>
							</div>
							<div class="rd-library-info">
								<div><strong>Status:</strong> <span class="status-${statusClass}">${torrent.status}</span></div>
								<div><strong>Size:</strong> ${size}</div>
								<div><strong>Added:</strong> ${added}</div>
							</div>
							<div class="rd-library-meta">
								<span>ID: ${torrent.id}</span>
								${torrent.host ? `<span>Host: ${torrent.host}</span>` : ''}
								${torrent.split ? `<span>Split: ${torrent.split}</span>` : ''}
								${torrent.speed ? `<span>Speed: ${formatBytes(torrent.speed)}/s</span>` : ''}
								${torrent.seeders ? `<span>Seeders: ${torrent.seeders}</span>` : ''}
							</div>
							${progress > 0 ? `
								<div class="rd-progress-bar">
									<div class="rd-progress-fill" style="width: ${progress}%"></div>
								</div>
							` : ''}
						</div>
					`;
				});

				content.innerHTML = html;
			}

			// Real-Debrid library helper functions
			function refreshRealDebridLibrary() {
				showRealDebridLibrary();
			}

			function filterLibrary() {
				const typeFilter = document.getElementById('rd-library-filter').value;
				const items = document.querySelectorAll('.rd-library-item');

				items.forEach(item => {
					const title = item.querySelector('.rd-library-title').textContent.toLowerCase();
					let matchesType = true;

					if (typeFilter !== 'all') {
						const fileType = getFileType(title);
						matchesType = fileType === typeFilter;
					}

					item.style.display = matchesType ? 'block' : 'none';
				});
			}

			function sortLibrary() {
				// Implementation for sorting would go here
				showToast('Sort functionality coming soon', 'info');
			}

			function downloadSelected() {
				const selected = Array.from(document.querySelectorAll('.rd-item-select:checked'));
				if (selected.length === 0) {
					showToast('No items selected', 'error');
					return;
				}
				showToast('Download functionality coming soon', 'info');
			}

			function deleteSelected() {
				const selected = Array.from(document.querySelectorAll('.rd-item-select:checked'));
				if (selected.length === 0) {
					showToast('No items selected', 'error');
					return;
				}
				
				if (confirm(`Delete ${selected.length} selected torrent(s)?`)) {
					showToast('Delete functionality coming soon', 'info');
				}
			}

			// Helper functions for Real-Debrid library
			function getFileType(filename) {
				const ext = filename.split('.').pop().toLowerCase();
				const videoExts = ['mp4', 'mkv', 'avi', 'mov', 'wmv', 'flv', 'm4v', 'webm'];
				const audioExts = ['mp3', 'flac', 'wav', 'aac', 'm4a', 'ogg'];
				const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz'];
				
				if (videoExts.includes(ext)) return 'video';
				if (audioExts.includes(ext)) return 'audio';
				if (archiveExts.includes(ext)) return 'archive';
				return 'other';
			}

			function formatBytes(bytes) {
				if (bytes === 0) return '0 Bytes';
				const k = 1024;
				const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
			}

			// Placeholder functions for Real-Debrid torrent actions
			function downloadRdTorrent(id) {
				showToast('Download functionality coming soon', 'info');
			}

			function selectRdFiles(id) {
				showToast('File selection functionality coming soon', 'info');
			}

			function deleteRdTorrent(id) {
				if (confirm('Delete this torrent?')) {
					showToast('Delete functionality coming soon', 'info');
				}
			}

			// Show toast notification
			function showToast(message, type = 'info', persistent = false) {
				const toastContainer = document.getElementById("toast-container") || createToastContainer();
				const toast = document.createElement("div");
				toast.className = `toast toast-${type}`;
				toast.innerHTML = message;

				const toastId = 'toast-' + Date.now();
				toast.id = toastId;

				if (persistent) {
					toast.classList.add("toast-persistent");
				}

				// Add toast styles if they don't exist
				if (!document.getElementById('toast-styles')) {
					const style = document.createElement('style');
					style.id = 'toast-styles';
					style.textContent = `
						#toast-container {
							position: fixed;
							top: 20px;
							right: 20px;
							z-index: 10000;
						}
						.toast {
							background: #333;
							color: white;
							padding: 12px 16px;
							margin-bottom: 10px;
							border-radius: 4px;
							min-width: 250px;
							box-shadow: 0 2px 10px rgba(0,0,0,0.3);
						}
						.toast-success { background: #28a745; }
						.toast-error { background: #dc3545; }
						.toast-warning { background: #ffc107; color: #000; }
						.toast-info { background: #17a2b8; }
					`;
					document.head.appendChild(style);
				}

				toastContainer.appendChild(toast);

				// Auto-remove toast after 3 seconds
				if (!persistent) {
					setTimeout(() => {
						if (toast.parentNode) {
							toast.remove();
						}
					}, 3000);
				}

				return toastId;
			}

			// Create toast container if it doesn't exist
			function createToastContainer() {
				const container = document.createElement("div");
				container.id = "toast-container";
				document.body.appendChild(container);
				return container;
			}

			// Close toast notification
			function closeToast(toastId) {
				const toast = document.getElementById(toastId);
				if (toast) {
					toast.remove();
				}
			}

			// Content tab switching function
			function switchContentTab(tabName) {
				// Remove active class from all tabs and content
				document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
				document.querySelectorAll('.content-settings').forEach(content => content.classList.remove('active'));
				
				// Add active class to clicked tab and corresponding content
				event.target.classList.add('active');
				document.getElementById(tabName + '-settings').classList.add('active');
			}

			// Add simple viewer functionality
			document.addEventListener('DOMContentLoaded', function() {
				const simpleViewBtn = document.getElementById('simpleViewBtn');
				if (simpleViewBtn) {
					simpleViewBtn.addEventListener('click', showSimpleViewer);
				}
			});

			function showSimpleViewer() {
				const iframe = document.querySelector('iframe');
				const currentFile = iframe.src;
				
				if (!currentFile) {
					showToast('No hash list loaded', 'error');
					return;
				}

				// Show the simple viewer modal
				document.getElementById('simpleViewerModal').style.display = 'block';
				loadSimpleView(currentFile);
			}

			async function loadSimpleView(fileUrl) {
				const content = document.getElementById('simple-viewer-content');
				content.innerHTML = '<div class="loading-simple">Loading hash list...</div>';

				try {
					// Extract the filename from URL
					const fileName = fileUrl.split('/').pop() || 'Hash List';
					
					// Try to fetch and parse the hash list file
					const response = await fetch(fileUrl);
					if (!response.ok) {
						throw new Error('Failed to load hash list');
									}

					const htmlContent = await response.text();
					
					// Extract the encoded data from the iframe src
					const iframeMatch = htmlContent.match(/src="([^"]+)"/);
					if (!iframeMatch) {
						throw new Error('Could not extract hash list data');
					}

					const iframeSrc = iframeMatch[1];
					const hashMatch = iframeSrc.match(/#(.+)$/);
					if (!hashMatch) {
						throw new Error('Could not find hash list data');
					}

					// For now, display basic info since decoding the hash list would require
					// understanding the debridmediamanager.com encoding format
					content.innerHTML = `
						<div class="simple-viewer">
							<div class="viewer-header">
								<h2>📄 ${fileName}</h2>
								<p>Hash list loaded from debridmediamanager.com</p>
							</div>
							<div class="viewer-content">
								<div class="hash-list-info">
									<div class="info-card">
										<h3>File Name</h3>
										<div class="value">${fileName}</div>
									</div>
									<div class="info-card">
										<h3>Status</h3>
										<div class="value">Loaded</div>
									</div>
									<div class="info-card">
										<h3>Source</h3>
										<div class="value">DMM</div>
									</div>
								</div>
								<div class="error-simple">
									<h3>📋 Hash List Data</h3>
									<p>This hash list contains encoded torrent data from debridmediamanager.com.</p>
									<p>The data is encoded and requires their platform to decode and display properly.</p>
									<p><strong>To view the actual torrents:</strong></p>
									<ul style="text-align: left; display: inline-block;">
										<li>Visit <a href="https://debridmediamanager.com" target="_blank">debridmediamanager.com</a></li>
										<li>Use their platform to browse hash lists</li>
										<li>The current hash list data is: <code style="word-break: break-all;">${hashMatch[1].substring(0, 100)}...</code></li>
									</ul>
								</div>
							</div>
						</div>
					`;

				} catch (error) {
					console.error('Error loading simple view:', error);
					content.innerHTML = `
						<div class="error-simple">
							<h3>❌ Error Loading Hash List</h3>
							<p>Could not load or parse the hash list file.</p>
							<p>Error: ${error.message}</p>
							<p>The file might be using a format that requires the debridmediamanager.com platform.</p>
						</div>
					`;
				}
			}

			function copyToClipboard(text) {
				navigator.clipboard.writeText(text).then(() => {
					showToast('Copied to clipboard!', 'success');
				}).catch(() => {
					showToast('Could not copy to clipboard', 'error');
				});
			}
		</script>
	</body>
</html>
