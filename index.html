<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Debrid Media Manager Hash List</title>
		<script src="api-manager.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
				overflow: hidden;
				font-family: sans-serif;
			}
			#panel {
				height: 80px;
				background-color: #f2f2f2;
				display: flex;
				align-items: center;
				padding: 0 10px;
				flex-wrap: wrap;
			}

			#panel #currentPath {
				flex-grow: 1;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				margin-right: 10px;
				min-width: 200px;
			}

			#panel button {
				margin-right: 10px;
				margin-bottom: 5px;
			}

			#search-container {
				display: flex;
				align-items: center;
				margin-right: 15px;
				margin-bottom: 5px;
			}

			#search-input {
				padding: 5px 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				margin-right: 5px;
				min-width: 200px;
			}

			#search-btn {
				padding: 5px 15px;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			#search-btn:hover {
				background-color: #0056b3;
			}

			#settings-btn {
				padding: 5px 15px;
				background-color: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				margin-right: 10px;
			}

			#settings-btn:hover {
				background-color: #1e7e34;
			}

			.status-indicators {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-right: 15px;
			}

			.status-indicator {
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: bold;
			}

			.status-connected {
				background-color: #28a745;
				color: white;
			}

			.status-disconnected {
				background-color: #dc3545;
				color: white;
			}

			iframe {
				border: none;
				position: absolute;
				top: 80px;
				left: 0;
				width: 100%;
				height: calc(100% - 80px);
			}

			#close a {
				font-size: xx-large;
				text-decoration: none;
			}

			/* Modal Styles */
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0,0,0,0.4);
			}

			.modal-content {
				background-color: #fefefe;
				margin: 5% auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
				max-width: 800px;
				border-radius: 8px;
				max-height: 80vh;
				overflow-y: auto;
			}

			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}

			.close:hover {
				color: black;
			}

			.settings-section {
				margin-bottom: 20px;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 5px;
			}

			.settings-section h3 {
				margin-top: 0;
				color: #333;
			}

			.form-group {
				margin-bottom: 15px;
			}

			.form-group label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
			}

			.form-group input, .form-group select {
				width: 100%;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				box-sizing: border-box;
			}

			.btn {
				padding: 8px 16px;
				margin: 5px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			.btn-primary {
				background-color: #007bff;
				color: white;
			}

			.btn-success {
				background-color: #28a745;
				color: white;
			}

			.btn-danger {
				background-color: #dc3545;
				color: white;
			}

			.search-results {
				max-height: 400px;
				overflow-y: auto;
				border: 1px solid #ddd;
				margin-top: 10px;
			}

			.search-result-item {
				padding: 10px;
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.search-result-item:last-child {
				border-bottom: none;
			}

			.search-result-info {
				flex-grow: 1;
			}

			.search-result-title {
				font-weight: bold;
				margin-bottom: 5px;
			}

			.search-result-source {
				color: #666;
				font-size: 12px;
			}

			.search-result-actions {
				display: flex;
				gap: 5px;
			}

			.loading {
				text-align: center;
				padding: 20px;
				color: #666;
			}

			.checkbox-group {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 10px;
			}

			.checkbox-item {
				display: flex;
				align-items: center;
				margin-right: 15px;
			}

			.checkbox-item input {
				margin-right: 5px;
				width: auto;
			}

			.content-type-tabs {
				display: flex;
				margin-bottom: 15px;
			}

			.tab-button {
				flex: 1;
				padding: 10px;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px 4px 0 0;
				cursor: pointer;
				text-align: center;
			}

			.tab-button:hover {
				background-color: #0056b3;
			}

			.tab-button.active {
				background-color: #0056b3;
			}

			.content-settings {
				display: none;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 0 0 4px 4px;
			}

			.content-settings.active {
				display: block;
			}
		</style>
	</head>
	<body>
		<div id="panel">
			<span id="currentPath"></span>
			
			<div id="search-container">
				<input type="text" id="search-input" placeholder="Search all hash lists...">
				<button id="search-btn">Search</button>
			</div>

			<div class="status-indicators">
				<span id="realdebrid-status" class="status-indicator status-disconnected">RD: Disconnected</span>
				<span id="trakt-status" class="status-indicator status-disconnected">Trakt: Disconnected</span>
			</div>

			<button id="settings-btn">‚öôÔ∏è Settings</button>
			<button id="library-btn">üìö Library</button>
			<button id="allHashlistsButton">All hash lists</button>
			<button id="previousButton">Previous hash list</button>
			<button id="randomButton">Random hash list</button>
			<button id="nextButton">Next hash list</button>
			<button onclick="showRealDebridLibrary()" class="rd-library-btn">üìö RD Library</button>
			<span id="close"><a href="https://debridmediamanager.com/">[X]</a></span>
		</div>

		<iframe src=""></iframe>

		<!-- Settings Modal -->
		<div id="settingsModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Settings</h2>

				<!-- Real-Debrid Settings -->
				<div class="settings-section">
					<h3>üî¥ Real-Debrid Configuration</h3>
					<div class="form-group">
						<label for="rd-api-key">API Key:</label>
						<input type="password" id="rd-api-key" placeholder="Enter your Real-Debrid API key">
						<small>Find your API key at <a href="https://real-debrid.com/apitoken" target="_blank">https://real-debrid.com/apitoken</a></small>
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick="testRealDebridConnection()">Test Connection</button>
						<button class="btn btn-success" onclick="saveRealDebridSettings()">Save</button>
					</div>
				</div>

				<!-- Trakt Settings -->
				<div class="settings-section">
					<h3>üì∫ Trakt Configuration</h3>
					<div class="form-group">
						<label for="trakt-client-id">Trakt Client ID:</label>
						<input type="text" id="trakt-client-id" class="form-control" placeholder="Enter your Trakt Client ID">
						<small>Get your Client ID from <a href="https://trakt.tv/oauth/applications" target="_blank">https://trakt.tv/oauth/applications</a></small>
					</div>
					<div class="form-group">
						<button class="btn btn-success" onclick="saveTraktClientId()">Save Client ID</button>
						<button class="btn btn-primary" onclick="connectTrakt()" id="trakt-connect-btn">Connect to Trakt</button>
						<button class="btn btn-danger" onclick="disconnectTrakt()" id="trakt-disconnect-btn" style="display: none;">Disconnect</button>
					</div>
					<div id="trakt-status-info"></div>
				</div>

				<!-- Auto-Add Settings -->
				<div class="settings-section">
					<h3>ü§ñ Auto-Add Configuration</h3>
					<div class="form-group">
						<label>
							<input type="checkbox" id="auto-add-movies"> Auto-add movies from Trakt watchlist to Real-Debrid
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="auto-add-shows"> Auto-add TV shows from Trakt watchlist to Real-Debrid
						</label>
					</div>
					<div class="form-group">
						<button class="btn btn-success" onclick="runAutoAdd()">Run Auto-Add Now</button>
					</div>
				</div>

				<!-- Content Type Tabs -->
				<div class="settings-section">
					<h3>‚öôÔ∏è Content Preferences</h3>
					<div class="content-type-tabs">
						<button class="tab-button active" onclick="switchContentTab('movies')">üé¨ Movies</button>
						<button class="tab-button" onclick="switchContentTab('shows')">üì∫ TV Shows</button>
					</div>

					<!-- Movies Settings -->
					<div id="movies-settings" class="content-settings active">
						<h4>Movie Preferences</h4>
						<div class="form-group">
							<label for="movie-quality-preference">Preferred Quality:</label>
							<select id="movie-quality-preference">
								<option value="2160p">4K (2160p)</option>
								<option value="1080p" selected>1080p</option>
								<option value="720p">720p</option>
								<option value="480p">480p</option>
							</select>
						</div>
						<div class="form-group">
							<label>File Type Preferences:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-remux" checked>
									<label for="movie-prefer-remux">REMUX</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-bluray" checked>
									<label for="movie-prefer-bluray">BluRay</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-prefer-web" checked>
									<label for="movie-prefer-web">WEB-DL/WEBRip</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="movie-hdr-preference">HDR Preference:</label>
							<select id="movie-hdr-preference">
								<option value="any">Any (HDR or SDR)</option>
								<option value="sdr-only">SDR Only (No HDR)</option>
								<option value="hdr-preferred">HDR Preferred</option>
								<option value="hdr-only">HDR Only</option>
							</select>
						</div>
						<div class="form-group">
							<label for="movie-max-size">Maximum file size:</label>
							<input type="text" id="movie-max-size" placeholder="e.g., 50GB, 100GB">
						</div>
						<div class="form-group">
							<label>Upgrade Settings:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="movie-auto-upgrade">
									<label for="movie-auto-upgrade">Auto-upgrade movies</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-allow-higher-quality">
									<label for="movie-allow-higher-quality">Allow higher quality</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="movie-delete-old">
									<label for="movie-delete-old">Delete old after upgrade</label>
								</div>
							</div>
						</div>
					</div>

					<!-- TV Shows Settings -->
					<div id="shows-settings" class="content-settings">
						<h4>TV Show Preferences</h4>
						<div class="form-group">
							<label for="show-quality-preference">Preferred Quality:</label>
							<select id="show-quality-preference">
								<option value="2160p">4K (2160p)</option>
								<option value="1080p" selected>1080p</option>
								<option value="720p">720p</option>
								<option value="480p">480p</option>
							</select>
						</div>
						<div class="form-group">
							<label>File Type Preferences:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-remux">
									<label for="show-prefer-remux">REMUX</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-bluray">
									<label for="show-prefer-bluray">BluRay</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-prefer-web" checked>
									<label for="show-prefer-web">WEB-DL/WEBRip</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="show-hdr-preference">HDR Preference:</label>
							<select id="show-hdr-preference">
								<option value="any">Any (HDR or SDR)</option>
								<option value="sdr-only" selected>SDR Only (No HDR)</option>
								<option value="hdr-preferred">HDR Preferred</option>
								<option value="hdr-only">HDR Only</option>
							</select>
						</div>
						<div class="form-group">
							<label for="show-max-size">Maximum file size per episode:</label>
							<input type="text" id="show-max-size" placeholder="e.g., 5GB, 10GB">
						</div>
						<div class="form-group">
							<label>Upgrade Settings:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-auto-upgrade">
									<label for="show-auto-upgrade">Auto-upgrade shows</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-allow-higher-quality">
									<label for="show-allow-higher-quality">Allow higher quality</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-delete-old">
									<label for="show-delete-old">Delete old after upgrade</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label>TV Show Specific Options:</label>
							<div class="checkbox-group">
								<div class="checkbox-item">
									<input type="checkbox" id="show-complete-seasons" checked>
									<label for="show-complete-seasons">Prefer complete seasons</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-next-episodes" checked>
									<label for="show-next-episodes">Auto-add next episodes</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="show-all-seasons">
									<label for="show-all-seasons">Add all seasons for new shows</label>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Global Quality Upgrade Settings -->
				<div class="settings-section">
					<h3>üìà Global Upgrade Configuration</h3>
					<div class="form-group">
						<label>
							<input type="checkbox" id="check-for-upgrades"> Check for quality upgrades during auto-add
						</label>
					</div>
					<div class="form-group">
						<label for="max-upgrade-matches">Max upgrade matches per title:</label>
						<input type="number" id="max-upgrade-matches" value="3" min="1" max="10">
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick="checkUpgradesNow()">Check for Upgrades Now</button>
					</div>
				</div>

				<!-- Search Settings -->
				<div class="settings-section">
					<h3>üîç Search Configuration</h3>
					<div class="form-group">
						<label for="search-limit">Maximum search results:</label>
						<input type="number" id="search-limit" value="50" min="10" max="200">
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="enable-regex" checked> Enable regex search
						</label>
					</div>
				</div>
			</div>
		</div>

		<!-- Search Results Modal -->
		<div id="searchModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Search Results</h2>
				<div id="search-results-container">
					<div class="loading">Searching...</div>
				</div>
			</div>
		</div>

		<!-- Library Modal -->
		<div id="libraryModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>All Hash Lists</h2>
				<div id="library-content">
					<div class="loading">Loading hash lists...</div>
				</div>
			</div>
		</div>

		<script>
			// Initialize API manager
			const apiManager = new APIManager();
			
			// On page load
			window.addEventListener("load", function () {
				let htmlFiles = [];
				let currentIndex = 0;

				const currentPathElement = document.getElementById("currentPath");
				const allHashlistsButton = document.getElementById("allHashlistsButton");
				const previousButton = document.getElementById("previousButton");
				const randomButton = document.getElementById("randomButton");
				const nextButton = document.getElementById("nextButton");
				const iframe = document.querySelector("iframe");

				// Define all functions first, before calling them
				function initializeSettings() {
					loadSettings();
					updateStatusIndicators();
				}

				function loadSettings() {
					const rdApiKey = localStorage.getItem('rd-api-key');
					
					if (rdApiKey) {
						document.getElementById('rd-api-key').value = rdApiKey;
					}
					
					// Load basic settings
					document.getElementById('auto-add-movies').checked = localStorage.getItem('auto-add-movies') === 'true';
					document.getElementById('auto-add-shows').checked = localStorage.getItem('auto-add-shows') === 'true';
					document.getElementById('search-limit').value = localStorage.getItem('search-limit') || '50';
					document.getElementById('enable-regex').checked = localStorage.getItem('enable-regex') !== 'false';
					
					// Load movie preferences
					const moviePrefs = JSON.parse(localStorage.getItem('movie-preferences') || '{}');
					document.getElementById('movie-quality-preference').value = moviePrefs.quality || '1080p';
					document.getElementById('movie-hdr-preference').value = moviePrefs.hdrPreference || 'any';
					document.getElementById('movie-max-size').value = moviePrefs.maxSize || '';
					document.getElementById('movie-auto-upgrade').checked = moviePrefs.autoUpgrade || false;
					document.getElementById('movie-allow-higher-quality').checked = moviePrefs.allowHigherQuality || false;
					document.getElementById('movie-delete-old').checked = moviePrefs.deleteOldAfterUpgrade || false;
					
					// Load movie file types
					const movieFileTypes = moviePrefs.fileTypes || ['remux', 'bluray', 'web'];
					document.getElementById('movie-prefer-remux').checked = movieFileTypes.includes('remux');
					document.getElementById('movie-prefer-bluray').checked = movieFileTypes.includes('bluray');
					document.getElementById('movie-prefer-web').checked = movieFileTypes.includes('web');

					// Load show preferences
					const showPrefs = JSON.parse(localStorage.getItem('show-preferences') || '{}');
					document.getElementById('show-quality-preference').value = showPrefs.quality || '1080p';
					document.getElementById('show-hdr-preference').value = showPrefs.hdrPreference || 'sdr-only';
					document.getElementById('show-max-size').value = showPrefs.maxSize || '';
					document.getElementById('show-auto-upgrade').checked = showPrefs.autoUpgrade || false;
					document.getElementById('show-allow-higher-quality').checked = showPrefs.allowHigherQuality || false;
					document.getElementById('show-delete-old').checked = showPrefs.deleteOldAfterUpgrade || false;
					document.getElementById('show-complete-seasons').checked = showPrefs.completeSeasonsPreferred || false;
					document.getElementById('show-next-episodes').checked = showPrefs.autoAddNextEpisodes || false;
					document.getElementById('show-all-seasons').checked = showPrefs.addAllSeasonsForNewShows || false;

					// Load saved Trakt Client ID
					const savedTraktClientId = localStorage.getItem('traktClientId');
					if (savedTraktClientId) {
						document.getElementById('trakt-client-id').value = savedTraktClientId;
					}
				}

				function updateStatusIndicators() {
					const rdStatus = document.getElementById("realdebrid-status");
					const traktStatus = document.getElementById("trakt-status");

					// Real-Debrid status
					rdStatus.classList.remove("status-connected", "status-disconnected");
					if (localStorage.getItem("rd-api-key")) {
						rdStatus.classList.add("status-connected");
						rdStatus.textContent = "RD: Connected";
					} else {
						rdStatus.classList.add("status-disconnected");
						rdStatus.textContent = "RD: Disconnected";
					}

					// Trakt status
					traktStatus.classList.remove("status-connected", "status-disconnected");
					if (localStorage.getItem("traktAccessToken")) {
						traktStatus.classList.add("status-connected");
						traktStatus.textContent = "Trakt: Connected";
					} else {
						traktStatus.classList.add("status-disconnected");
						traktStatus.textContent = "Trakt: Disconnected";
					}
				}

				function updateTraktStatus() {
					const traktStatusInfo = document.getElementById("trakt-status-info");
					if (localStorage.getItem("traktAccessToken")) {
						traktStatusInfo.innerHTML = "Connected to Trakt as <strong>" + localStorage.getItem("traktUserName") + "</strong>";
					} else {
						traktStatusInfo.innerHTML = "";
					}
				}

				// Load settings and update UI
				initializeSettings();

				// Load all HTML files in the "hashlists" directory
				fetch("hashlists/")
					.then(response => response.text())
					.then(data => {
						const parser = new DOMParser();
						const doc = parser.parseFromString(data, "text/html");
						const links = doc.querySelectorAll("a");

						links.forEach(link => {
							const href = link.getAttribute("href");
							if (href && href.endsWith(".html")) {
								htmlFiles.push(href);
							}
						});

						// Set initial iframe source to the first file
						if (htmlFiles.length > 0) {
							iframe.src = htmlFiles[0];
							currentPathElement.textContent = htmlFiles[0];
						}
					})
					.catch(error => console.error("Error loading hashlists:", error));

				// Button event listeners
				allHashlistsButton.addEventListener("click", function () {
					if (htmlFiles.length > 0) {
						currentIndex = 0;
						iframe.src = htmlFiles[currentIndex];
						currentPathElement.textContent = htmlFiles[currentIndex];
					}
				});

				previousButton.addEventListener("click", function () {
					if (htmlFiles.length > 0) {
						currentIndex = (currentIndex > 0) ? currentIndex - 1 : htmlFiles.length - 1;
						iframe.src = htmlFiles[currentIndex];
						currentPathElement.textContent = htmlFiles[currentIndex];
					}
				});

				randomButton.addEventListener("click", function () {
					if (htmlFiles.length > 0) {
						currentIndex = Math.floor(Math.random() * htmlFiles.length);
						iframe.src = htmlFiles[currentIndex];
						currentPathElement.textContent = htmlFiles[currentIndex];
					}
				});

				nextButton.addEventListener("click", function () {
					if (htmlFiles.length > 0) {
						currentIndex = (currentIndex < htmlFiles.length - 1) ? currentIndex + 1 : 0;
						iframe.src = htmlFiles[currentIndex];
						currentPathElement.textContent = htmlFiles[currentIndex];
					}
				});

				// Search button event listener
				document.getElementById("search-btn").addEventListener("click", function () {
					const query = document.getElementById("search-input").value.trim();
					if (query) {
						openSearchModal(query);
					}
				});

				// Settings button event listener
				document.getElementById("settings-btn").addEventListener("click", function () {
					document.getElementById("settingsModal").style.display = "block";
				});

				// Library button event listener
				document.getElementById("library-btn").addEventListener("click", function () {
					openLibraryModal();
				});

				// Close modal event listeners
				const closeModalButtons = document.querySelectorAll(".close");
				closeModalButtons.forEach(button => {
					button.addEventListener("click", function () {
						const modal = button.closest(".modal");
						if (modal) {
							modal.style.display = "none";
						}
					});
				});

				// Click outside modal to close
				window.addEventListener("click", function (event) {
					const modals = document.querySelectorAll(".modal");
					modals.forEach(modal => {
						if (event.target === modal) {
							modal.style.display = "none";
						}
					});
				});
			});

			// Connect to Trakt
			async function connectTrakt() {
				const clientId = localStorage.getItem('traktClientId');
				if (!clientId) {
					showToast('Please enter and save your Trakt Client ID first', 'error');
					return;
				}

				const redirectUri = window.location.origin + window.location.pathname;
				const authUrl = `https://trakt.tv/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}`;
				
				// Store the client ID for later use
				localStorage.setItem('traktClientId', clientId);
				
				// Open Trakt authorization in a new window
				const authWindow = window.open(authUrl, 'traktAuth', 'width=600,height=700');
				
				// Listen for the authorization code
				const checkClosed = setInterval(() => {
					if (authWindow.closed) {
						clearInterval(checkClosed);
						// Check if we got the authorization code from URL parameters
						const urlParams = new URLSearchParams(window.location.search);
						const code = urlParams.get('code');
						
						if (code) {
							exchangeCodeForToken(code, clientId, redirectUri);
							// Clean up URL
							window.history.replaceState({}, document.title, window.location.pathname);
						}
					}
				}, 1000);
			}

			async function exchangeCodeForToken(code, clientId, redirectUri) {
				try {
					const response = await fetch('https://api.trakt.tv/oauth/token', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							code: code,
							client_id: clientId,
							client_secret: '', // You'll need to add this to your app
							redirect_uri: redirectUri,
							grant_type: 'authorization_code'
						})
					});

					if (response.ok) {
						const data = await response.json();
						localStorage.setItem('traktAccessToken', data.access_token);
						localStorage.setItem('traktRefreshToken', data.refresh_token);
						showToast('Successfully connected to Trakt!', 'success');
						updateStatusIndicators();
						updateTraktStatus();
					} else {
						showToast('Failed to connect to Trakt', 'error');
					}
				} catch (error) {
					showToast('Error connecting to Trakt: ' + error.message, 'error');
				}
			}

			function disconnectTrakt() {
				localStorage.removeItem('traktAccessToken');
				localStorage.removeItem('traktRefreshToken');
				showToast('Disconnected from Trakt', 'success');
				updateStatusIndicators();
				updateTraktStatus();
			}

			// Test Real-Debrid connection
			function testRealDebridConnection() {
				const apiKey = document.getElementById('rd-api-key').value.trim();
				if (!apiKey) {
					showToast('Please enter your Real-Debrid API key', 'error');
					return;
				}

				fetch('https://api.real-debrid.com/rest/1.0/user', {
					method: 'GET',
					headers: {
						'Authorization': 'Bearer ' + apiKey
					}
				})
				.then(response => {
					if (response.ok) {
						showToast('Real-Debrid connection successful!', 'success');
					} else {
						showToast('Real-Debrid connection failed. Please check your API key.', 'error');
					}
				})
				.catch(error => {
					showToast('Error connecting to Real-Debrid: ' + error.message, 'error');
				});
			}

			// Save Real-Debrid settings
			function saveRealDebridSettings() {
				const apiKey = document.getElementById('rd-api-key').value.trim();
				if (!apiKey) {
					showToast('Please enter your Real-Debrid API key', 'error');
					return;
				}

				localStorage.setItem('rd-api-key', apiKey);
				showToast('Real-Debrid settings saved', 'success');
				updateStatusIndicators();
			}

			// Update save function to also update API manager
			function saveTraktClientId() {
				const clientId = document.getElementById('trakt-client-id').value.trim();
				if (!clientId) {
					showToast('Please enter a valid Trakt Client ID', 'error');
					return;
				}

				localStorage.setItem('traktClientId', clientId);
				// Update the API manager with the new client ID
				window.apiManager.updateTraktClientId(clientId);
				showToast('Trakt Client ID saved', 'success');
			}

			// Load saved Trakt Client ID when page loads
			function loadTraktClientId() {
				const savedClientId = localStorage.getItem('traktClientId');
				if (savedClientId) {
					document.getElementById('trakt-client-id').value = savedClientId;
				}
			}

			// Call loadTraktClientId when the page loads
			document.addEventListener('DOMContentLoaded', loadTraktClientId);

			// Run Auto-Add now
			function runAutoAdd() {
				const autoAddMovies = document.getElementById('auto-add-movies').checked;
				const autoAddShows = document.getElementById('auto-add-shows').checked;

				if (!autoAddMovies && !autoAddShows) {
					showToast('Please enable at least one Auto-Add option (Movies or Shows)', 'error');
					return;
				}

				// Show a loading toast
				const toastId = showToast('Running Auto-Add... Please wait.', 'info', true);

				// Simulate Auto-Add process
				setTimeout(() => {
					// Here you would typically call the actual Auto-Add function
					// For demonstration, we're just closing the toast after 3 seconds
					closeToast(toastId);
					showToast('Auto-Add completed!', 'success');
				}, 3000);
			}

			// Check for upgrades now
			function checkUpgradesNow() {
				const maxMatches = document.getElementById('max-upgrade-matches').value;
				if (maxMatches < 1 || maxMatches > 10) {
					showToast('Max upgrade matches must be between 1 and 10', 'error');
					return;
				}

				// Show a loading toast
				const toastId = showToast('Checking for upgrades... Please wait.', 'info', true);

				// Simulate upgrade check process
				setTimeout(() => {
					// Here you would typically call the actual upgrade check function
					// For demonstration, we're just closing the toast after 3 seconds
					closeToast(toastId);
					showToast('Upgrade check completed!', 'success');
				}, 3000);
			}

			// Open search modal
			function openSearchModal(query) {
				const modal = document.getElementById("searchModal");
				const resultsContainer = document.getElementById("search-results-container");
				resultsContainer.innerHTML = '<div class="loading">Searching...</div>';

				// Show modal
				modal.style.display = "block";

				// Perform search
				apiManager.searchHashLists(query)
					.then(results => {
						resultsContainer.innerHTML = "";
						if (results.length === 0) {
							resultsContainer.innerHTML = '<div class="loading">No results found</div>';
							return;
						}

						results.forEach(result => {
							const item = document.createElement("div");
							item.className = "search-result-item";
							item.innerHTML = `
								<div class="search-result-info">
									<div class="search-result-title">${result.title}</div>
									<div class="search-result-source">${result.source}</div>
								</div>
								<div class="search-result-actions">
									<button class="btn btn-primary" onclick="openHashList('${result.file}')">Open</button>
								</div>
							`;
							resultsContainer.appendChild(item);
						});
					})
					.catch(error => {
						resultsContainer.innerHTML = '<div class="loading">Error fetching results</div>';
						console.error("Search error:", error);
					});
			}

			// Open specific hash list
			function openHashList(file) {
				const iframe = document.querySelector("iframe");
				const currentPathElement = document.getElementById("currentPath");
				iframe.src = file;
				currentPathElement.textContent = file;
			}

			// Open library modal
			function openLibraryModal() {
				const modal = document.getElementById("libraryModal");
				const libraryContent = document.getElementById("library-content");
				libraryContent.innerHTML = '<div class="loading">Loading hash lists...</div>';

				// Show modal
				modal.style.display = "block";

				// Load all hash list files
				apiManager.getAllHashListFiles()
					.then(files => {
						libraryContent.innerHTML = ""; // Clear loading message
						if (files.length === 0) {
							libraryContent.innerHTML = '<div class="loading">No hash lists found</div>';
							return;
						}

						files.forEach(file => {
							const item = document.createElement("div");
							item.className = "search-result-item";
							item.innerHTML = `
								<div class="search-result-info">
									<div class="search-result-title">${file}</div>
								</div>
								<div class="search-result-actions">
									<button class="btn btn-primary" onclick="openHashList('${file}')">Open</button>
								</div>
							`;
							libraryContent.appendChild(item);
						});
					})
					.catch(error => {
						libraryContent.innerHTML = '<div class="loading">Error loading hash lists</div>';
						console.error("Library load error:", error);
					});
			}

			// Show toast notification
			function showToast(message, type = 'info', persistent = false) {
				const toastContainer = document.getElementById("toast-container") || createToastContainer();
				const toast = document.createElement("div");
				toast.className = `toast toast-${type}`;
				toast.innerText = message;

				if (persistent) {
					toast.classList.add("toast-persistent");
				}

				toastContainer.appendChild(toast);

				// Auto-remove toast after 3 seconds
				if (!persistent) {
					setTimeout(() => {
						toast.remove();
					}, 3000);
				}
			}

			// Create toast container if it doesn't exist
			function createToastContainer() {
				const container = document.createElement("div");
				container.id = "toast-container";
				document.body.appendChild(container);
				return container;
			}

			// Close toast notification
			function closeToast(toastElement) {
				if (toastElement) {
					toastElement.remove();
				}
			}

			// Show Real-Debrid library
			function showRealDebridLibrary() {
				const apiKey = localStorage.getItem('rd-api-key');
				if (!apiKey) {
					showToast('Please enter and save your Real-Debrid API key first', 'error');
					return;
				}

				// Open Real-Debrid library in a new tab
				window.open('https://real-debrid.com/library', '_blank');
			}

			// APIManager class methods
			class APIManager {
				constructor() {
					this.realDebridApiKey = localStorage.getItem('rd-api-key');
				}

				// ...existing methods...

				async getRealDebridDownloads() {
					const response = await fetch('https://api.real-debrid.com/rest/1.0/downloads', {
						headers: {
							'Authorization': `Bearer ${this.realDebridApiKey}`
						}
					});
					return await response.json();
				},

				async getAllHashListFiles() {
					const response = await fetch('hashlists/');
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					const text = await response.text();
					const parser = new DOMParser();
					const doc = parser.parseFromString(text, 'text/html');
					const links = doc.querySelectorAll('a');
					const files = Array.from(links).map(link => link.getAttribute('href')).filter(href => href && href.endsWith('.html'));
					return files;
				},
			}
		</script>
	</body>
</html>
